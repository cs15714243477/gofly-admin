{"version":3,"file":"index.js","sources":["utils/request/index.js"],"sourcesContent":["/**\r\n * utils-request\r\n * @description api模块管理，loading配置，请求拦截，错误处理\r\n */\r\nimport { getCurrentInstance } from 'vue'; \r\nimport Request from 'luch-request';\r\nimport { baseUrl, apiPath ,apiModel} from '@/utils/config';\r\nimport $store from '@/store';\r\nimport md5 from 'js-md5'\r\n\r\n// base64 编码（兼容小程序端无 window.btoa）\r\nfunction base64Encode(str = '') {\r\n  try {\r\n    // #ifdef H5\r\n    return window.btoa(str);\r\n    // #endif\r\n  } catch (e) {}\r\n\r\n  // #ifndef H5\r\n  const utf8ToBytes = (s) => {\r\n    const bytes = [];\r\n    for (let i = 0; i < s.length; i++) {\r\n      let codePoint = s.charCodeAt(i);\r\n      if (codePoint < 0x80) {\r\n        bytes.push(codePoint);\r\n      } else if (codePoint < 0x800) {\r\n        bytes.push(0xc0 | (codePoint >> 6));\r\n        bytes.push(0x80 | (codePoint & 0x3f));\r\n      } else {\r\n        bytes.push(0xe0 | (codePoint >> 12));\r\n        bytes.push(0x80 | ((codePoint >> 6) & 0x3f));\r\n        bytes.push(0x80 | (codePoint & 0x3f));\r\n      }\r\n    }\r\n    return new Uint8Array(bytes);\r\n  };\r\n  const buf = utf8ToBytes(str).buffer;\r\n  // wx/uni 都提供 arrayBufferToBase64\r\n  // eslint-disable-next-line no-undef\r\n  if (typeof wx !== 'undefined' && wx.arrayBufferToBase64) return wx.arrayBufferToBase64(buf);\r\n  if (typeof uni !== 'undefined' && uni.arrayBufferToBase64) return uni.arrayBufferToBase64(buf);\r\n  return '';\r\n  // #endif\r\n}\r\nconst options = {\r\n  // 显示操作成功消息 默认不显示\r\n  showSuccess: false,\r\n  // 成功提醒 默认使用后端返回值\r\n  successMsg: '',\r\n  // 显示失败消息 默认显示\r\n  showError: true,\r\n  // 失败提醒 默认使用后端返回信息\r\n  errorMsg: '',\r\n  // 显示请求时loading模态框 默认显示\r\n  showLoading: true,\r\n  // loading提醒文字\r\n  loadingMsg: '加载中',\r\n  // 需要授权才能请求 默认放开\r\n  auth: false,\r\n  // ...\r\n};\r\n\r\n// Loading全局实例\r\nlet LoadingInstance = {\r\n  target: null,\r\n  count: 0,\r\n};\r\n\r\n/**\r\n * 关闭loading\r\n */\r\nfunction closeLoading() {\r\n  if (LoadingInstance.count > 0) LoadingInstance.count--;\r\n  if (LoadingInstance.count === 0) uni.hideLoading();\r\n}\r\n\r\n/**\r\n * @description 请求基础配置 可直接使用访问自定义请求\r\n */\r\nconst http = new Request({\r\n  baseURL:  baseUrl+apiModel,\r\n  timeout: 8000,\r\n  method: 'GET',\r\n  // #ifdef APP-PLUS\r\n  sslVerify: false,\r\n  // #endif\r\n  // #ifdef H5\r\n  // 跨域请求时是否携带凭证（cookies）仅H5支持（HBuilderX 2.6.15+）\r\n  withCredentials: false,\r\n  // #endif\r\n  custom: options,\r\n});\r\n\r\n/**\r\n * @description 请求拦截器\r\n */\r\nhttp.interceptors.request.use(\r\n  (config) => {\r\n\t// 兼容：小程序“重新打开/刷新”时 store 可能尚未恢复 isLogin，但本地 token 已存在\r\n\tconst token = uni.getStorageSync('token');\r\n\tif (token && !$store('user').isLogin) {\r\n\t  $store('user').setToken(token);\r\n\t}\r\n    if (config.custom.auth && !token && !$store('user').isLogin) {\r\n      // 这里做未登录拦截\r\n      return Promise.reject();\r\n    }\r\n    if (config.custom.showLoading) {\r\n      LoadingInstance.count++;\r\n      LoadingInstance.count === 0 &&\r\n        uni.showLoading({\r\n          title: config.custom.loadingMsg,\r\n          mask: true,\r\n          fail: () => {\r\n            uni.hideLoading();\r\n          },\r\n        });\r\n    }\r\n\t// 判断本地是否存在token，如果存在则带上请求头\r\n\tlet timestamp = Date.parse(new Date().toString())/1000;\r\n\t const passstr=md5(import.meta.env.GF_API_SECRET+timestamp)\r\n\tlet baseheader = {\r\n\t\t Accept: 'text/json',\r\n\t\t'Content-Type': 'application/json;charset=UTF-8',\r\n\t\t'Businessid': import.meta.env.GF_BUSINESUSSID,\r\n\t\t'apiverify': base64Encode(passstr+\"#\"+timestamp),\r\n\t};\r\n\tif (token) {\r\n\t\tbaseheader=Object.assign({},baseheader,{\r\n\t\t\tAuthorization: `${token}`\t// 这里是token(可自行修改)\r\n\t\t})\r\n\t  }\r\n\tconfig.header =baseheader;//请求头\r\n    return config;\r\n  },\r\n  (error) => {\r\n    return Promise.reject(error);\r\n  },\r\n);\r\n\r\n/**\r\n * @description 响应拦截器\r\n */\r\nhttp.interceptors.response.use(\r\n  (response) => {\r\n    // 自动设置登陆令牌\r\n    if (response.header.authorization || response.header.Authorization) {\r\n      $store('user').setToken(response.header.authorization || response.header.Authorization);\r\n    }\r\n\r\n    response.config.custom.showLoading && closeLoading();\r\n    if (response.data.code !== 0) {\r\n      if (response.config.custom.showError)\r\n        uni.showToast({\r\n          title: response.data.message || '服务器开小差啦,请稍后再试~',\r\n          icon: 'none',\r\n          mask: true,\r\n        });\r\n      return Promise.resolve(response.data);\r\n    }\r\n    if (\r\n      response.data.code !== 0 &&\r\n      response.data.message !== '' &&\r\n      response.config.custom.showSuccess\r\n    ) {\r\n      uni.showToast({\r\n        title: response.config.custom.successMsg || response.data.message,\r\n        icon: 'none',\r\n      });\r\n    }\r\n\tif(response.data&& response.data.token){\r\n\t\tconst userStore = $store('user');\r\n\t\tuserStore.setToken(response.data.token)\r\n\t}\r\n    return Promise.resolve(response.data);\r\n  },\r\n  (error) => {\r\n    const userStore = $store('user');\r\n    const isLogin = userStore.isLogin;\r\n    let errorMessage = '网络请求出错';\r\n    if (error !== undefined) {\r\n      switch (error.statusCode) {\r\n        case 400:\r\n          errorMessage = '请求错误';\r\n          break;\r\n        case 401:\r\n          if (isLogin) {\r\n            errorMessage = '您的登陆已过期';\r\n          } else {\r\n            errorMessage = '请先登录';\r\n          }\r\n          userStore.logout(true);\r\n          break;\r\n        case 403:\r\n          errorMessage = '拒绝访问';\r\n          break;\r\n        case 404:\r\n          errorMessage = '请求出错';\r\n          break;\r\n        case 408:\r\n          errorMessage = '请求超时';\r\n          break;\r\n        case 429:\r\n          errorMessage = '请求频繁, 请稍后再访问';\r\n          break;\r\n        case 500:\r\n          errorMessage = '服务器开小差啦,请稍后再试~';\r\n          break;\r\n        case 501:\r\n          errorMessage = '服务未实现';\r\n          break;\r\n        case 502:\r\n          errorMessage = '网络错误';\r\n          break;\r\n        case 503:\r\n          errorMessage = '服务不可用';\r\n          break;\r\n        case 504:\r\n          errorMessage = '网络超时';\r\n          break;\r\n        case 505:\r\n          errorMessage = 'HTTP版本不受支持';\r\n          break;\r\n      }\r\n      // if (error.errMsg.includes('timeout')) errorMessage = '请求超时';\r\n      // #ifdef H5\r\n      // if (error.errMsg.includes('Network'))\r\n      //   errorMessage = window.navigator.onLine ? '服务器异常' : '请检查您的网络连接';\r\n      // #endif\r\n    }\r\n\r\n    if (error && error.config) {\r\n      if (error.config.custom.showError === false) {\r\n        uni.showToast({\r\n          title: error.data?.message || errorMessage,\r\n          icon: 'none',\r\n          mask: true,\r\n        });\r\n      }\r\n      error.config.custom.showLoading && closeLoading();\r\n    }\r\n\r\n    return false;\r\n  },\r\n);\r\n\r\nconst request = (config) => {\r\n  // -------- URL 规范化：避免出现 /uniapp/uniapp/*、/business/business/* ----------\r\n  // 场景：baseURL 已包含 apiModel(/uniapp)，而调用方 url 也写了 /uniapp/xxx，拼接后变成 /uniapp/uniapp/xxx\r\n  if (config && typeof config.url === 'string') {\r\n    const url = config.url;\r\n    const model = typeof apiModel === 'string' ? apiModel : '';\r\n    const pathPrefix = typeof apiPath === 'string' ? apiPath : '';\r\n    // 去掉重复的 apiModel 前缀\r\n    if (model && model.startsWith('/') && url.startsWith(model + '/')) {\r\n      config.url = url.slice(model.length);\r\n    }\r\n    // 去掉重复的 apiPath 前缀\r\n    if (pathPrefix && pathPrefix.startsWith('/') && config.url.startsWith(pathPrefix + '/')) {\r\n      config.url = config.url.slice(pathPrefix.length);\r\n    }\r\n    // 常见重复：/business/business/*\r\n    if (config.url.startsWith('/business/business/')) {\r\n      config.url = config.url.replace('/business/business/', '/business/');\r\n    }\r\n    // 常见重复：/uniapp/uniapp/*\r\n    if (config.url.startsWith('/uniapp/uniapp/')) {\r\n      config.url = config.url.replace('/uniapp/uniapp/', '/uniapp/');\r\n    }\r\n  }\r\n\r\n  // 兼容接口前缀：你期望后端路径为 /business/xxx/yyy\r\n  // 若环境变量未配置 apiModel/apiPath 的 /business 前缀，则这里兜底补齐。\r\n  // 只对业务接口做前缀补齐，避免影响绝对地址或第三方请求。\r\n\r\n  const needBusinessPrefix =\r\n    (typeof apiModel !== 'string' || !apiModel.includes('/business')) &&\r\n    (typeof apiPath !== 'string' || !apiPath.startsWith('/business'));\r\n  if (needBusinessPrefix && typeof config.url === 'string' && config.url.startsWith('/') && !config.url.startsWith('/business/')) {\r\n    config.url = '/business' + config.url;\r\n  }\r\n\r\n  if (config.url[0] !== '/') {\r\n     config.url = apiPath + config.url;\r\n  }\r\n  return http.middleware(config);\r\n};\r\n\r\nexport default request;\r\n"],"names":["wx","uni","Request","baseUrl","apiModel","$store","md5","apiPath"],"mappings":"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"}