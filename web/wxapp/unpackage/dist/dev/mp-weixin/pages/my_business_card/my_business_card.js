"use strict";const e=require("../../common/vendor.js"),t=require("../../api/user.js"),a=require("../../store/index.js"),i=require("../../utils/config/index.js");function r(t=""){const a=(e=>{const t=[];for(let a=0;a<e.length;a++){let i=e.charCodeAt(a);i<128?t.push(i):i<2048?(t.push(192|i>>6),t.push(128|63&i)):(t.push(224|i>>12),t.push(128|i>>6&63),t.push(128|63&i))}return new Uint8Array(t)})(t).buffer;return void 0!==e.wx$1&&e.wx$1.arrayBufferToBase64?e.wx$1.arrayBufferToBase64(a):void 0!==e.index$1&&e.index$1.arrayBufferToBase64?e.index$1.arrayBufferToBase64(a):""}const s={components:{BottomTabBar:()=>"../../components/BottomTabBar.js",TopHeader:()=>"../../components/TopHeader.js"},onLoad(e){const t=e&&(e.tab||e.currentTab);"1"!==t&&1!==t&&"edit"!==t||(this.currentTab=1),this.initCanvasSize(),this.loadProfile().catch((()=>{}))},onShow(){this.loadProfile(!1).catch((()=>{}))},onShareAppMessage(){const e=this.profile&&this.profile.name||"我",t=Number(this.loadedUserId||0),a=Number(this.currentPreview||0);return{title:`${e}的名片`,path:`/pages/agent_public_card/agent_public_card?agent_id=${encodeURIComponent(t)}&style=${encodeURIComponent(a)}`}},data:()=>({currentTab:0,currentPreview:0,qrCodeUrl:"",styleChangeTimer:null,saving:!1,savingImage:!1,tagPopupVisible:!1,newTagText:"",loadedUserId:0,storeOptions:[],canvasWidth:900,canvasHeight:1320,canvasScale:2,profile:{avatar:"",name:"",phone:"",wechat:"",role:"",store_id:0,store:"",store_address:"",email:"",intro:"",tags:[]},suggestTags:["学区房专家","二手房买卖","新房咨询","高端别墅","婚房首选","投资置业"],cardStyles:[{bg:"linear-gradient(135deg, #2d9cf0, #1e40af)",decor2:"rgba(249, 115, 22, 0.2)",badge:"PRO",badgeBg:"#f97316"},{bg:"linear-gradient(135deg, #06b6d4, #2563eb)",decor2:"rgba(255, 255, 255, 0.12)",badge:"TOP",badgeBg:"#22c55e"},{bg:"linear-gradient(135deg, #111827, #334155)",decor2:"rgba(45, 156, 240, 0.18)",badge:"VIP",badgeBg:"#2d9cf0"}]}),computed:{previewCards(){const e=this.profile||{},t=Array.isArray(e.tags)?e.tags.slice(0,3):[];return(this.cardStyles||[]).map((a=>({...a,name:e.name,role:e.role,phone:e.phone,wechat:e.wechat,store:e.store,avatar:e.avatar,tags:t})))}},watch:{currentTab(e){1===Number(e)&&this.loadStores().catch((()=>{}))}},methods:{initCanvasSize(){try{const t=e.index$1.getSystemInfoSync?e.index$1.getSystemInfoSync():{},a=Number(t.pixelRatio||2);this.canvasScale=Math.max(2,Math.min(3,a||2)),this.canvasWidth=900,this.canvasHeight=1320}catch(t){}},onPreviewChange(e){this.currentPreview=e.detail.current,this.persistDefaultStyle(),this.scheduleWxaCodeRefresh()},safeImage:e=>String(e||"").trim()||"/static/images/img_155372af18.png",extrasStorageKey:e=>`wxapp_my_business_card_extras_${e||0}`,loadExtras(t){const a=this.extrasStorageKey(t),i=e.index$1.getStorageSync(a);if(!i)return{};try{return"string"==typeof i?JSON.parse(i):i||{}}catch(r){return{}}},saveExtras(t){const a=this.extrasStorageKey(t),i={wechat:String(this.profile.wechat||"").trim(),tags:Array.isArray(this.profile.tags)?this.profile.tags:[]};try{e.index$1.setStorageSync(a,JSON.stringify(i))}catch(r){e.index$1.setStorageSync(a,i)}},async loadProfile(i=!0){if(!e.index$1.getStorageSync("token")&&!a.$store("user").isLogin)return;const r=await t.userApi.getCardProfile(!!i);if(!r||0!==r.code)return;const s=r.data||{},o=Number(s.id||s.ID||0);this.loadedUserId=o,this.profile.avatar=s.avatar||"",this.profile.name=s.name||s.nickname||"",this.profile.phone=s.mobile||"",this.profile.role=s.title||s.role||"",this.profile.store_id=Number(s.store_id||0),this.profile.store=s.store_name||"",this.profile.store_address=s.store_address||"",this.profile.email=s.email||"",this.profile.intro=s.introduction||"";const n=Number(e.index$1.getStorageSync(this.styleStorageKey(o))||0);!Number.isNaN(n)&&n>=0&&(this.currentPreview=n);const l=this.loadExtras(o);l&&("string"==typeof l.wechat&&(this.profile.wechat=l.wechat),Array.isArray(l.tags)&&(this.profile.tags=l.tags)),this.loadWxaCode(!1).catch((()=>{}))},styleStorageKey:e=>`wxapp_my_business_card_style_${e||0}`,persistDefaultStyle(){this.loadedUserId&&e.index$1.setStorageSync(this.styleStorageKey(this.loadedUserId),Number(this.currentPreview||0))},scheduleWxaCodeRefresh(){this.styleChangeTimer&&(clearTimeout(this.styleChangeTimer),this.styleChangeTimer=null),this.styleChangeTimer=setTimeout((()=>{this.loadWxaCode(!1).catch((()=>{}))}),220)},async loadWxaCode(i=!0){if(!e.index$1.getStorageSync("token")&&!a.$store("user").isLogin)return;const r={style:Number(this.currentPreview||0)};(!("undefined"==typeof process||!process.env)||void 0!==e.wx$1&&e.wx$1.getAccountInfoSync&&["develop","trial"].includes((e.wx$1.getAccountInfoSync().miniProgram||{}).envVersion))&&(r.check_path=!1);const s=await t.userApi.getAgentWxaCode(r,!!i);s&&0===s.code&&(this.qrCodeUrl=s.data&&s.data.url||"")},previewQrCode(){if(!this.qrCodeUrl)return e.index$1.showToast({title:"小程序码生成中...",icon:"none"}),void this.loadWxaCode(!0).catch((()=>{}));e.index$1.previewImage({urls:[this.qrCodeUrl]})},async loadStores(){if(!e.index$1.getStorageSync("token")&&!a.$store("user").isLogin)return;const i=await t.userApi.getStores(!1);if(!i||0!==i.code)return;const r=Array.isArray(i.data)?i.data:[];this.storeOptions=r},onStorePickerChange(t){const a=Number(t&&t.detail?t.detail.value:-1);if(!Array.isArray(this.storeOptions)||0===this.storeOptions.length)return void e.index$1.showToast({title:"暂无可选门店",icon:"none"});if(a<0||a>=this.storeOptions.length)return;const i=this.storeOptions[a]||{};this.profile.store_id=Number(i.id||0),this.profile.store=i.name||"",this.profile.store_address=i.address||""},showUneditable(t){e.index$1.showToast({title:t||"不支持修改",icon:"none"})},openAddTag(){this.newTagText="",this.tagPopupVisible=!0},closeAddTag(){this.tagPopupVisible=!1,this.newTagText=""},confirmAddTag(){const t=String(this.newTagText||"").trim();t?(this.addTag(t),this.closeAddTag()):e.index$1.showToast({title:"请输入标签内容",icon:"none"})},addTag(t){const a=String(t||"").trim();a&&(Array.isArray(this.profile.tags)||(this.profile.tags=[]),this.profile.tags.includes(a)||(this.profile.tags.length>=6?e.index$1.showToast({title:"最多添加6个标签",icon:"none"}):this.profile.tags=this.profile.tags.concat([a])))},removeTag(e){Array.isArray(this.profile.tags)&&(this.profile.tags=this.profile.tags.filter(((t,a)=>a!==e)))},async saveProfile(){if(this.saving)return;const i=String(this.profile.name||"").trim();if(i){this.saving=!0;try{const r={avatar:this.profile.avatar,name:i,title:String(this.profile.role||"").trim(),introduction:String(this.profile.intro||"").trim(),store_id:Number(this.profile.store_id||0)},s=await t.userApi.updateCardProfile(r,!0);if(!s||0!==s.code)return;this.loadedUserId&&this.saveExtras(this.loadedUserId);const o=a.$store("user");o.setUserInfo({...o.userInfo||{},avatar:this.profile.avatar,name:this.profile.name}),e.index$1.showToast({title:"保存成功",icon:"none"})}finally{this.saving=!1}}else e.index$1.showToast({title:"请填写姓名",icon:"none"})},async changeAvatar(){this.saving||e.index$1.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async e=>{const t=e&&e.tempFilePaths&&e.tempFilePaths[0];t&&await this.uploadAvatar(t)}})},uploadAvatar(t){return new Promise(((a,s)=>{const o=e.index$1.getStorageSync("token"),n=Math.floor(Date.now()/1e3),l={Accept:"text/json",Businessid:"1",apiverify:r(e.md5("gofly@888"+n)+"#"+n)};o&&(l.Authorization=`${o}`),e.index$1.uploadFile({url:`${i.baseUrl}/common/upload/upFile`,filePath:t,name:"file",formData:{filetype:"image"},header:l,success:t=>{try{const i=t&&t.data?t.data:"{}",r="string"==typeof i?JSON.parse(i):i;if(!r||0!==r.code)return e.index$1.showToast({title:r&&r.message||"上传失败",icon:"none"}),void s(r);const o=r&&r.data?r.data.url:"";this.profile.avatar=o||"",e.index$1.showToast({title:"头像已更新",icon:"none"}),a(r)}catch(i){e.index$1.showToast({title:"解析上传结果失败",icon:"none"}),s(i)}},fail:t=>{e.index$1.showToast({title:"上传失败",icon:"none"}),s(t)}})}))},saveCardImage(){this.saveCardToAlbum().catch((()=>{}))},copyCardLink(){this.copyUrlLink().catch((()=>{}))},async copyUrlLink(){const a=Number(this.currentPreview||0);let i="";if(void 0!==e.wx$1&&e.wx$1.getAccountInfoSync){const t=(e.wx$1.getAccountInfoSync().miniProgram||{}).envVersion;"develop"!==t&&"trial"!==t&&"release"!==t||(i=t)}const r=await t.userApi.getAgentUrlLink({style:a,env_version:i},!0),s=r&&0===r.code&&r.data?r.data.url_link:"";s?e.index$1.setClipboardData({data:s,success:()=>e.index$1.showToast({title:"已复制链接",icon:"none"})}):e.index$1.showToast({title:"获取链接失败",icon:"none"})},showMoreActions(){e.index$1.showActionSheet({itemList:["刷新资料","清空本地名片扩展信息"],success:async t=>{if(0===t.tapIndex&&await this.loadProfile(!0).catch((()=>{})),1===t.tapIndex){if(!this.loadedUserId)return;e.index$1.removeStorageSync(this.extrasStorageKey(this.loadedUserId)),this.profile.wechat="",this.profile.tags=[],e.index$1.showToast({title:"已清空",icon:"none"})}}})},getGradientColors(e){const t=String(e||"").match(/#(?:[0-9a-fA-F]{3}){1,2}/g)||[];return t.length>=2?[t[0],t[1]]:["#2d9cf0","#1e40af"]},drawRoundRectPath(e,t,a,i,r,s){const o=Math.max(0,Math.min(s,i/2,r/2));e.beginPath(),e.moveTo(t+o,a),e.arcTo(t+i,a,t+i,a+r,o),e.arcTo(t+i,a+r,t,a+r,o),e.arcTo(t,a+r,t,a,o),e.arcTo(t,a,t+i,a,o),e.closePath()},getImageInfo:t=>new Promise(((a,i)=>{if(!t)return i(new Error("empty src"));e.index$1.getImageInfo({src:t,success:e=>a(e),fail:e=>i(e)})})),async saveCardToAlbum(){if(!this.savingImage){this.savingImage=!0;try{if(this.qrCodeUrl||await this.loadWxaCode(!0).catch((()=>{})),!this.qrCodeUrl)return void e.index$1.showToast({title:"小程序码生成失败",icon:"none"});const t=this.previewCards[this.currentPreview]||this.previewCards[0],a=this.canvasWidth*this.canvasScale,i=this.canvasHeight*this.canvasScale,r=(this.canvasScale,e=>Number(e)*(a/900)),s=e=>ath.round(Number(e)*(a/900)),o=e.index$1.createCanvasContext("cardCanvas",this);o.save(),this.drawRoundRectPath(o,0,0,a,i,r(40)),o.clip();const[n,l]=this.getGradientColors(t.bg),c=o.createLinearGradient(0,0,a,i);c.addColorStop(0,n),c.addColorStop(1,l),o.setFillStyle(c),o.fillRect(0,0,a,i),o.setFillStyle("rgba(255,255,255,0.10)"),o.beginPath(),o.arc(a-r(80),r(80),r(140),0,2*Math.PI),o.fill(),o.setFillStyle(String(t.decor2||"rgba(249,115,22,0.18)")),o.beginPath(),o.arc(r(80),i-r(120),r(180),0,2*Math.PI),o.fill(),o.setFillStyle("rgba(255,255,255,0.22)"),this.drawRoundRectPath(o,r(40),r(40),r(520),r(70),r(16)),o.fill(),o.setFillStyle("#ffffff"),o.setFontSize(s(28)),o.fillText(String(t.store||"未绑定门店"),r(60),r(86)),o.setFillStyle(String(t.badgeBg||"#f97316")),this.drawRoundRectPath(o,a-r(180),r(44),r(140),r(60),r(30)),o.fill(),o.setFillStyle("#ffffff"),o.setFontSize(s(22)),o.fillText(String(t.badge||"PRO"),a-r(140),r(82));const d=await this.getImageInfo(this.safeImage(t.avatar)),h=r(200),g=(a-h)/2,f=r(170);o.save(),o.beginPath(),o.arc(a/2,f+h/2,h/2,0,2*Math.PI),o.clip(),o.drawImage(d.path,g,f,h,h),o.restore(),o.setStrokeStyle("rgba(255,255,255,0.28)"),o.setLineWidth(Math.max(2,r(6))),o.beginPath(),o.arc(a/2,f+h/2,h/2,0,2*Math.PI),o.stroke(),o.setFillStyle("#ffffff"),o.setFontSize(s(44));const p=String(t.name||"");o.fillText(p,(a-o.measureText(p).width)/2,r(430)),o.setFontSize(s(28)),o.setFillStyle("rgba(255,255,255,0.85)");const u=String(t.role||"置业顾问");o.fillText(u,(a-o.measureText(u).width)/2,r(475)),o.setFillStyle("rgba(255,255,255,0.12)"),this.drawRoundRectPath(o,r(60),r(520),a-r(120),r(120),r(24)),o.fill(),o.setFillStyle("rgba(255,255,255,0.72)"),o.setFontSize(s(22)),o.fillText("电话",r(90),r(570)),o.setFillStyle("#ffffff"),o.setFontSize(s(30));const m=String(t.phone||"");o.fillText(m,r(90),r(612)),o.setFillStyle("rgba(255,255,255,0.92)"),o.setFontSize(s(26));const v="微信号："+String(t.wechat||"");o.fillText(v,r(70),i-r(230));const y="门店："+String(t.store||"");o.fillText(y,r(70),i-r(190));const w=await this.getImageInfo(this.qrCodeUrl);o.setFillStyle("#ffffff"),this.drawRoundRectPath(o,a-r(260),i-r(300),r(200),r(200),r(16)),o.fill(),o.drawImage(w.path,a-r(250),i-r(290),r(180),r(180)),o.setFillStyle("rgba(255,255,255,0.78)"),o.setFontSize(s(20)),o.fillText("微信识别进入",a-r(250),i-r(80)),o.restore(),await new Promise((e=>o.draw(!1,e)));const T=await new Promise(((t,r)=>{e.index$1.canvasToTempFilePath({canvasId:"cardCanvas",x:0,y:0,width:a,height:i,destWidth:a,destHeight:i,fileType:"png",quality:1,success:e=>t(e),fail:e=>r(e)},this)}));await new Promise(((t,a)=>{e.index$1.saveImageToPhotosAlbum({filePath:T.tempFilePath,success:()=>t(!0),fail:e=>a(e)})})),e.index$1.showToast({title:"已保存到相册",icon:"none"})}catch(t){e.index$1.showModal({title:"保存失败",content:"请允许保存到相册权限后重试",confirmText:"去设置",cancelText:"取消",success:t=>{t.confirm&&e.index$1.openSetting({})}})}finally{this.savingImage=!1}}}}};if(!Array){(e.resolveComponent("TopHeader")+e.resolveComponent("BottomTabBar"))()}const o=e._export_sfc(s,[["render",function(t,a,i,r,s,o){return e.e({a:e.p({title:"获客"}),b:0===s.currentTab?1:"",c:e.o((e=>s.currentTab=0)),d:1===s.currentTab?1:"",e:e.o((e=>s.currentTab=1)),f:0===s.currentTab},0===s.currentTab?{g:e.f(o.previewCards,((e,t,a)=>({a:t,b:s.currentPreview===t?1:""}))),h:e.f(o.previewCards,((t,a,i)=>e.e({a:t.decor2,b:e.t(t.store||"未绑定门店"),c:e.t(t.badge),d:t.badgeBg,e:o.safeImage(t.avatar),f:e.t(t.name),g:e.t(t.role),h:e.f(t.tags,((t,a,i)=>({a:e.t(t),b:a}))),i:e.t(t.phone),j:e.t(t.wechat),k:e.t(t.store)},s.qrCodeUrl?{l:s.qrCodeUrl}:{},{m:e.o(((...e)=>o.previewQrCode&&o.previewQrCode(...e)),a),n:t.bg,o:a}))),i:s.qrCodeUrl,j:s.currentPreview,k:e.o(((...e)=>o.onPreviewChange&&o.onPreviewChange(...e)))}:{},{l:1===s.currentTab},1===s.currentTab?e.e({m:o.safeImage(s.profile.avatar),n:e.o(((...e)=>o.changeAvatar&&o.changeAvatar(...e))),o:s.profile.name,p:e.o((e=>s.profile.name=e.detail.value)),q:e.t(s.profile.phone),r:e.o((e=>o.showUneditable("手机号由平台绑定，不支持修改"))),s:s.profile.wechat,t:e.o((e=>s.profile.wechat=e.detail.value)),v:s.profile.role,w:e.o((e=>s.profile.role=e.detail.value)),x:e.t(s.profile.store||"请选择门店"),y:s.storeOptions,z:e.o(((...e)=>o.onStorePickerChange&&o.onStorePickerChange(...e))),A:s.profile.store_address},s.profile.store_address?{B:e.t(s.profile.store_address)}:{},{C:s.profile.intro,D:e.o((e=>s.profile.intro=e.detail.value)),E:e.o(((...e)=>o.openAddTag&&o.openAddTag(...e))),F:e.f(s.profile.tags,((t,a,i)=>({a:e.t(t),b:"active-"+a,c:e.o((e=>o.removeTag(a)),"active-"+a)}))),G:e.f(s.suggestTags,((t,a,i)=>({a:e.t(t),b:"suggest-"+a,c:e.o((e=>o.addTag(t)),"suggest-"+a)})))}):{},{H:0===s.currentTab},0===s.currentTab?{I:e.o(((...e)=>o.saveCardImage&&o.saveCardImage(...e))),J:e.o(((...e)=>o.copyCardLink&&o.copyCardLink(...e))),K:e.o(((...e)=>o.showMoreActions&&o.showMoreActions(...e)))}:{},{L:1===s.currentTab},1===s.currentTab?{M:e.t(s.saving?"保存中...":"保存修改"),N:s.saving,O:e.o(((...e)=>o.saveProfile&&o.saveProfile(...e)))}:{},{P:s.tagPopupVisible},s.tagPopupVisible?{Q:s.newTagText,R:e.o((e=>s.newTagText=e.detail.value)),S:e.o(((...e)=>o.closeAddTag&&o.closeAddTag(...e))),T:e.o(((...e)=>o.confirmAddTag&&o.confirmAddTag(...e))),U:e.o((()=>{})),V:e.o(((...e)=>o.closeAddTag&&o.closeAddTag(...e)))}:{},{W:e.p({active:"marketing"}),X:s.canvasWidth+"px",Y:s.canvasHeight+"px",Z:s.canvasWidth*s.canvasScale,aa:s.canvasHeight*s.canvasScale})}]]);s.__runtimeHooks=2,wx.createPage(o);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/my_business_card/my_business_card.js.map
