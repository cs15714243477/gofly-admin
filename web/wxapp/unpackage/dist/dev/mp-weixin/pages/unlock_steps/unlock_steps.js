"use strict";const e=require("../../common/vendor.js"),t=require("../../api/ttlock.js");function i(e){return String(e).padStart(2,"0")}const s={components:{TopHeader:()=>"../../components/TopHeader.js"},data:()=>({propertyId:0,unlocking:!1,unlockRequestId:0,ble:{supported:!0,initStatus:"idle",available:!1,discovering:!1,connected:!1,deviceId:"",errorMsg:""},bleLogs:[],bleLogMax:50,_bleListening:!1,_lastBleStateKey:"",_lastConnKey:""}),computed:{bleInitText(){if(!this.ble.supported)return"不支持";switch(this.ble.initStatus){case"initting":return"初始化中";case"ready":return"已就绪";case"failed":return"失败";case"unsupported":return"不支持";default:return"未初始化"}},bleInitClass(){return"ready"===this.ble.initStatus?"ok":"failed"===this.ble.initStatus?"warn":"initting"===this.ble.initStatus?"loading":"muted"},bleBadgeText(){return this.ble.supported&&"unsupported"!==this.ble.initStatus?"failed"===this.ble.initStatus?"蓝牙不可用":this.ble.available?"可用":"未开启/不可用":"当前平台不支持"},bleBadgeClass(){return this.ble.supported&&"unsupported"!==this.ble.initStatus?"failed"===this.ble.initStatus?"warn":this.ble.available?"ok":"warn":"muted"},bleConnectText(){return this.ble.connected?"已连接":this.unlocking?"连接中":"未连接"},statusText(){return this.ble.supported&&"unsupported"!==this.ble.initStatus?"initting"===this.ble.initStatus?"正在初始化蓝牙…":"failed"===this.ble.initStatus?this.ble.errorMsg?`蓝牙初始化失败：${this.ble.errorMsg}`:"蓝牙初始化失败":this.ble.available?this.unlocking?"正在连接并开锁…":this.ble.connected?"设备已连接":"蓝牙就绪，等待连接":"请开启手机蓝牙后重试":"当前平台不支持蓝牙能力"},statusTagClass(){return this.ble.supported&&"unsupported"!==this.ble.initStatus?"failed"!==this.ble.initStatus&&this.ble.available?this.unlocking||"initting"===this.ble.initStatus?"loading":"ok":"warn":"muted"},latestBleLogs(){return this.bleLogs.slice(-3)}},onLoad(e){const t=Number(e&&(e.property_id||e.id)||0);this.propertyId=Number.isFinite(t)?t:0},onShow(){this.appendBleLog("info","进入页面，开始检测蓝牙状态"),this.initBluetooth()},onHide(){this.cleanupBluetooth()},onUnload(){this.cleanupBluetooth()},methods:{goBack(){e.index$1.navigateBack()},appendBleLog(e,t){const s=new Date,n=`${i(s.getHours())}:${i(s.getMinutes())}:${i(s.getSeconds())}`;this.bleLogs.push({time:n,msg:String(t||""),level:e||"info"}),this.bleLogs.length>this.bleLogMax&&this.bleLogs.splice(0,this.bleLogs.length-this.bleLogMax)},formatBleErr(e){if(!e)return"";const t=Number(e.errCode||e.code||0),i=String(e.errMsg||e.message||"").trim();if(10001===t)return"蓝牙适配器不可用（请开启手机蓝牙）";if(10002===t)return"没有找到指定设备";if(10003===t)return"连接失败";if(10004===t)return"没有找到指定服务";if(10005===t)return"没有找到指定特征值";if(10006===t)return"当前连接已断开";if(10007===t)return"当前特征值不支持该操作";if(10008===t)return"其余所有系统上报的异常";if(10009===t)return"系统版本低于 4.3 不支持 BLE";if(10010===t)return"系统版本低于 4.4 不支持 BLE";if(10011===t)return"需要授权蓝牙权限";if(i)return i;if(t)return`蓝牙异常（错误码：${t}）`;try{return JSON.stringify(e)}catch(s){}return"蓝牙异常"},async reportUnlockActivity(e,i){if(this.propertyId&&t.ttlockApi&&"function"==typeof t.ttlockApi.logUnlockActivity)try{await t.ttlockApi.logUnlockActivity({property_id:this.propertyId,stage:e,page:"unlock_steps",meta:i||{}})}catch(s){}},async initBluetooth(){if("initting"!==this.ble.initStatus&&"ready"!==this.ble.initStatus){this.ble.supported=!0,this.ble.initStatus="initting",this.ble.errorMsg="",this.appendBleLog("info","开始初始化蓝牙适配器"),this.reportUnlockActivity("ble_init_start",{});try{await new Promise(((t,i)=>{e.index$1.openBluetoothAdapter({success:t,fail:i})})),this.ble.initStatus="ready",this.appendBleLog("success","蓝牙适配器初始化成功"),await this.refreshBluetoothState(),this.bindBluetoothListeners(),this.reportUnlockActivity("ble_init_ok",{available:this.ble.available,discovering:this.ble.discovering})}catch(t){this.ble.initStatus="failed",this.ble.errorMsg=this.formatBleErr(t),this.appendBleLog("error",`蓝牙初始化失败：${this.ble.errorMsg||"未知错误"}`),this.reportUnlockActivity("ble_init_fail",{err_code:Number(t&&(t.errCode||t.code)||0),err_msg:this.formatBleErr(t)})}}},async refreshBluetoothState(){try{const t=await new Promise(((t,i)=>{e.index$1.getBluetoothAdapterState({success:t,fail:i})}));this.ble.available=!!t.available,this.ble.discovering=!!t.discovering;const i=`${this.ble.available}_${this.ble.discovering}`;this._lastBleStateKey=i,this.appendBleLog("info",`蓝牙状态：${this.ble.available?"可用":"不可用"}${this.ble.discovering?"，搜索中":""}`)}catch(t){this.appendBleLog("warn",`获取蓝牙状态失败：${this.formatBleErr(t)}`)}},bindBluetoothListeners(){if(!this._bleListening){this._bleListening=!0;try{e.index$1.onBluetoothAdapterStateChange((e=>{this.ble.available=!!e.available,this.ble.discovering=!!e.discovering;const t=`${this.ble.available}_${this.ble.discovering}`;t!==this._lastBleStateKey&&(this._lastBleStateKey=t,this.appendBleLog("info",`蓝牙状态变化：${this.ble.available?"可用":"不可用"}${this.ble.discovering?"，搜索中":""}`),this.reportUnlockActivity("ble_state_change",{available:this.ble.available,discovering:this.ble.discovering}))}))}catch(t){}try{e.index$1.onBLEConnectionStateChange((e=>{this.ble.connected=!!e.connected,e&&e.deviceId&&(this.ble.deviceId=e.deviceId);const t=`${this.ble.connected}_${this.ble.deviceId||""}`;t!==this._lastConnKey&&(this._lastConnKey=t,this.appendBleLog(this.ble.connected?"success":"warn",`连接状态：${this.ble.connected?"已连接":"已断开"}${this.ble.deviceId?`，设备 ${this.ble.deviceId}`:""}`),this.reportUnlockActivity("ble_conn_change",{connected:this.ble.connected,deviceId:this.ble.deviceId}))}))}catch(t){}}},unbindBluetoothListeners(){if(this._bleListening){this._bleListening=!1;try{e.index$1.offBluetoothAdapterStateChange()}catch(t){}try{e.index$1.offBLEConnectionStateChange()}catch(t){}}},cleanupBluetooth(){this.unbindBluetoothListeners();try{e.index$1.closeBluetoothAdapter({})}catch(t){}},async bluetoothUnlock(){if(this.unlocking)return;if(!this.propertyId)return void e.index$1.showToast({title:"缺少房源ID，无法开锁",icon:"none"});this.unlocking=!0;let i=null,s=0,n=!1,o=0,r="",l=null;try{if(this.appendBleLog("info","用户点击蓝牙开锁"),await this.initBluetooth(),"failed"===this.ble.initStatus||"unsupported"===this.ble.initStatus)throw r=this.ble.errorMsg||"蓝牙不可用，请开启后重试",new Error(r);if(i=requirePlugin("ttlock-plugin"),!i||"function"!=typeof i.controlLock)throw r="未检测到通通锁插件，请检查小程序插件配置",new Error(r);const a=await t.ttlockApi.bleUnlockStart({property_id:this.propertyId,meta:{page:"unlock_steps",ble:{available:this.ble.available,connected:this.ble.connected,deviceId:this.ble.deviceId}}});if(s=Number(a&&a.data&&a.data.request_id)||0,!s)throw r=a&&a.message?a.message:"创建开锁记录失败",new Error(r);this.unlockRequestId=s,this.appendBleLog("info",`已创建开锁记录：#${s}`),this.appendBleLog("info","正在获取开锁数据");const c=await t.ttlockApi.getPropertyBleInfo({property_id:this.propertyId});if(!c||0!==c.code)throw r=c&&c.message?c.message:"获取开锁数据失败",new Error(r);const d=c.data||{},h=String(d.key_data||d.lock_data||"").trim();if(!h)throw r="缺少开锁数据，请先同步钥匙信息",new Error(r);if(e.index$1.showLoading({title:"蓝牙开锁中",mask:!0}),this.appendBleLog("info","开始调用蓝牙插件开锁（连接中）"),l=await i.controlLock({controlAction:3,lockData:h,serverTime:Date.now()}),e.index$1.hideLoading(),l&&0===Number(l.errorCode))n=!0,o=0,r="",this.appendBleLog("success","开锁成功"),e.index$1.showToast({title:"开锁成功",icon:"success"});else{n=!1,o=Number(l&&l.errorCode)||0;const t=l&&(l.errorMsg||l.errMsg||l.description)||"开锁失败，请重试";r=t,this.appendBleLog("error",`开锁失败：${t}`),e.index$1.showToast({title:t,icon:"none"})}}catch(a){try{e.index$1.hideLoading()}catch(c){}const t=a&&a.message?a.message:"开锁失败，请稍后重试";r||(r=t),this.appendBleLog("error",t),e.index$1.showToast({title:t,icon:"none"})}finally{if(s>0)try{await t.ttlockApi.bleUnlockFinish({property_id:this.propertyId,request_id:s,success:n?1:0,err_code:n?0:o,err_msg:n?"":r,meta:{page:"unlock_steps",ble:{available:this.ble.available,connected:this.ble.connected,deviceId:this.ble.deviceId},plugin:l?{errorCode:l.errorCode,errorMsg:l.errorMsg||l.errMsg||l.description||""}:null}})}catch(a){this.appendBleLog("warn","写入开锁结果日志失败（不影响开锁结果）")}try{i&&"function"==typeof i.stopAllOperations&&await i.stopAllOperations()}catch(a){}this.unlocking=!1}},passwordUnlock(){e.index$1.navigateTo({url:`/pages/unlock_details/unlock_details?property_id=${encodeURIComponent(this.propertyId)}`})}}};if(!Array){e.resolveComponent("TopHeader")()}const n=e._export_sfc(s,[["render",function(t,i,s,n,o,r){return e.e({a:e.o(((...e)=>r.goBack&&r.goBack(...e))),b:e.p({title:"开锁步骤"}),c:e.t(r.bleBadgeText),d:e.n(r.bleBadgeClass),e:e.t(r.statusText),f:e.n(r.statusTagClass),g:e.t(r.bleInitText),h:e.n(r.bleInitClass),i:e.t(o.ble.available?"是":"否"),j:e.t(o.ble.discovering?"是":"否"),k:e.t(r.bleConnectText),l:o.ble.deviceId},o.ble.deviceId?{m:e.t(o.ble.deviceId)}:{},{n:o.ble.errorMsg},o.ble.errorMsg?{o:e.t(o.ble.errorMsg)}:{},{p:e.t(r.latestBleLogs.length),q:e.t(o.bleLogMax),r:e.f(r.latestBleLogs,((t,i,s)=>({a:e.t(t.time),b:e.t(t.msg),c:e.n(t.level),d:i}))),s:!r.latestBleLogs.length},(r.latestBleLogs.length,{}),{t:e.o(((...e)=>r.bluetoothUnlock&&r.bluetoothUnlock(...e))),v:e.o(((...e)=>r.passwordUnlock&&r.passwordUnlock(...e)))})}]]);wx.createPage(n);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/unlock_steps/unlock_steps.js.map
