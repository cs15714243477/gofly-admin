"use strict";const e=require("../../common/vendor.js"),o=require("../../api/user.js"),n=require("../../store/index.js"),t={components:{BottomTabBar:()=>"../../components/BottomTabBar.js",TopHeader:()=>"../../components/TopHeader.js"},onShareAppMessage(){const e=this.displayName||"我",o=Number(this.userInfo&&this.userInfo.id||0);return{title:`${e}的名片`,path:`/pages/agent_public_card/agent_public_card?agent_id=${encodeURIComponent(o)}&style=0`}},data:()=>({loadingUser:!1,debugLogged:!1,userInfo:{},recordSummary:{follow_count:0,unlock_count:0,showing_count:0,view_count:0,share_count:0,call_count:0,unlock_has_notice:!1},businessRecords:[{key:"property_manage",name:"房源管理",icon:"home_work"},{key:"lock_manage",name:"智能门锁",icon:"lock"},{key:"follow",name:"关注记录",icon:"favorite"},{key:"unlock",name:"开锁记录",icon:"lock_open",hasNotice:!0},{key:"showing",name:"带看记录",icon:"location_on"},{key:"view",name:"浏览记录",icon:"history"},{key:"share",name:"分享记录",icon:"share"},{key:"call",name:"通话记录",icon:"call"}]}),computed:{avatarUrl(){const e=String(this.userInfo&&this.userInfo.avatar||"").trim();return e?0===e.indexOf("/static/images/")?"":e:""},displayName(){const e=this.userInfo||{};return e.name||e.nickname||e.username||"未登录"},displayRoleLine(){const e=this.userInfo||{},o=(e.title||"").trim(),n=String(e.role||"").trim(),t=(e.store_name||"").trim(),r=t||"未绑定";let a=o;return a||(a=""===n||"1"===n||"user"===n.toLowerCase()?"经纪人":n),`${a} | ${r}`},displayMobile(){return(this.userInfo||{}).mobile||""},displayRecords(){const e=this.userInfo||{},o=1===Number(e.can_manage_properties),n=1===Number(e.can_manage_locks),t=this.recordSummary||{},r={follow:Number(t.follow_count||0),unlock:Number(t.unlock_count||0),showing:Number(t.showing_count||0),view:Number(t.view_count||0),share:Number(t.share_count||0),call:Number(t.call_count||0)};return(this.businessRecords||[]).filter((e=>!!e&&("property_manage"===e.key?o:"lock_manage"!==e.key||n))).map((e=>{const o=r[e.key]||0;return{...e,hasNotice:"unlock"===e.key?!!t.unlock_has_notice:!!e.hasNotice,countLabel:o>0?`${o}条`:""}}))}},onShow(){this.ensureLoginAndLoadUser()},methods:{debugPrintUserInfo(o=""){var n,t,r,a;if(!this.debugLogged){this.debugLogged=!0;try{e.index$1.__f__("log","at pages/agent_workbench_home/agent_workbench_home.vue:266","[agent_workbench_home] "+(o||"userInfo")+" store_name=",null==(n=this.userInfo)?void 0:n.store_name,"store_id=",null==(t=this.userInfo)?void 0:t.store_id,"title=",null==(r=this.userInfo)?void 0:r.title,"role=",null==(a=this.userInfo)?void 0:a.role),e.index$1.__f__("log","at pages/agent_workbench_home/agent_workbench_home.vue:276","[agent_workbench_home] "+(o||"userInfo")+" full=",JSON.parse(JSON.stringify(this.userInfo||{})))}catch(s){e.index$1.__f__("log","at pages/agent_workbench_home/agent_workbench_home.vue:281","[agent_workbench_home] debugPrintUserInfo error",s)}}},debugShowUserInfo(){try{const o=this.userInfo||{},n=[`name: ${o.name||""}`,`nickname: ${o.nickname||""}`,`username: ${o.username||""}`,`title: ${o.title||""}`,`role: ${o.role||""}`,`store_name: ${o.store_name||""}`,`store_id: ${o.store_id||""}`,`store_address: ${o.store_address||""}`];e.index$1.showModal({title:"调试：userInfo(点击头像)",content:n.join("\n"),showCancel:!1})}catch(o){e.index$1.showToast({title:"调试弹窗失败",icon:"none"})}},async ensureLoginAndLoadUser(){const o=n.$store("user"),t=e.index$1.getStorageSync("token");if(t&&!o.isLogin&&o.setToken(t),t||o.isLogin){if(!this.loadingUser){this.loadingUser=!0;try{const e=await o.getInfo();this.userInfo=e||o.userInfo||{},this.debugPrintUserInfo("after getInfo"),await this.loadWorkbenchSummary(!1)}catch(r){this.userInfo=o.userInfo||{},this.debugPrintUserInfo("fallback userStore.userInfo"),await this.loadWorkbenchSummary(!1)}finally{this.loadingUser=!1}}}else e.index$1.reLaunch({url:"/pages/login/login"})},async loadWorkbenchSummary(e=!1){try{const n=await o.userApi.getWorkbenchSummary(e);if(!n||0!==n.code||!n.data)return;this.recordSummary={follow_count:Number(n.data.follow_count||0),unlock_count:Number(n.data.unlock_count||0),showing_count:Number(n.data.showing_count||0),view_count:Number(n.data.view_count||0),share_count:Number(n.data.share_count||0),call_count:Number(n.data.call_count||0),unlock_has_notice:!!n.data.unlock_has_notice}}catch(n){}},goEditCard(){e.index$1.reLaunch({url:"/pages/my_business_card/my_business_card?tab=1"})},openAbout(){e.index$1.navigateTo({url:"/pages/doc_webview/doc_webview?key=help_center"})},async copyAgentLink(){const n=await o.userApi.getAgentUrlLink({},!0),t=n&&0===n.code&&n.data?String(n.data.url_link||"").trim():"";t?e.index$1.setClipboardData({data:t,success:()=>e.index$1.showToast({title:"已复制链接",icon:"none"})}):e.index$1.showToast({title:"获取链接失败",icon:"none"})},openRecord(o){const n=o&&o.key&&{property_manage:"/pages/property_manage/property_manage",lock_manage:"/pages/lock_manage/lock_manage",follow:"/pages/records/record_follow",unlock:"/pages/records/record_unlock",showing:"/pages/records/record_showing",view:"/pages/records/record_view",share:"/pages/records/record_share",call:"/pages/records/record_call"}[o.key];n&&e.index$1.navigateTo({url:n})},getRecordHint:e=>({property_manage:"维护发布、编辑、上下架",lock_manage:"远程开锁、门锁状态管理",follow:"客户关注房源动态",unlock:"开锁日志与异常提醒",showing:"带看安排与到访回溯",view:"浏览来源与热度追踪",share:"分享触达与传播记录",call:"客户来电与沟通统计"}[String(e&&e.key||"").trim()]||"点击进入查看明细"),getRecordFooter(e){const o=String(e&&e.countLabel||"").trim();return o?`累计 ${o}`:"点击进入查看明细"},handleLogout(){e.index$1.showModal({title:"提示",content:"确定要退出登录吗？",success:async o=>{if(o.confirm){try{await n.$store("user").logout(!1)}catch(t){}e.index$1.reLaunch({url:"/pages/login/login"})}}})}}};if(!Array){(e.resolveComponent("TopHeader")+e.resolveComponent("BottomTabBar"))()}const r=e._export_sfc(t,[["render",function(o,n,t,r,a,s){return e.e({a:e.p({title:"我的"}),b:e.o(((...e)=>s.goEditCard&&s.goEditCard(...e))),c:s.avatarUrl},s.avatarUrl?{d:s.avatarUrl}:{},{e:e.t(s.displayName),f:e.t(s.displayRoleLine),g:e.t(s.displayMobile),h:e.f(s.displayRecords,((o,n,t)=>e.e({a:e.t(o.icon),b:o.hasNotice},(o.hasNotice,{}),{c:o.hasNotice?1:"",d:e.t(o.name),e:e.t(s.getRecordHint(o)),f:e.t(o.countLabel||"暂无统计"),g:e.t(o.hasNotice?"有新动态":"点击查看详情"),h:e.t(o.hasNotice?"notifications_active":"insights"),i:e.t(s.getRecordFooter(o)),j:e.n(o.hasNotice?"orange-footer":"grey-footer"),k:n,l:e.o((e=>s.openRecord(o)),n)}))),i:e.o(((...e)=>s.openAbout&&s.openAbout(...e))),j:e.o(((...e)=>s.copyAgentLink&&s.copyAgentLink(...e))),k:e.o(((...e)=>s.handleLogout&&s.handleLogout(...e))),l:e.p({active:"me"})})}]]);t.__runtimeHooks=2,wx.createPage(r);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/agent_workbench_home/agent_workbench_home.js.map
