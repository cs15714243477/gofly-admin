"use strict";const t=require("../../common/vendor.js"),e=require("../../api/ttlock.js"),i=require("../../api/property.js"),r=require("../../store/index.js"),o={components:{TopHeader:()=>"../../components/TopHeader.js"},data:()=>({permissionChecked:!1,loading:!1,refreshing:!1,finished:!1,syncing:!1,page:1,pageSize:20,total:0,list:[],keyword:"",status:{config_ok:!1,has_token:!1,api_base:"",expire_at:0},bindVisible:!1,bindLock:null,propertyKeyword:"",propertyLoading:!1,propertyFinished:!1,propertyPage:1,propertyPageSize:15,propertyList:[]}),computed:{filteredLocks(){const t=String(this.keyword||"").trim().toLowerCase(),e=Array.isArray(this.list)?this.list:[];return t?e.filter((e=>{const i=String(e&&e.lock_name).toLowerCase(),r=String(e&&e.lock_mac).toLowerCase(),o=String(e&&e.ttlock_lock_id);return i.includes(t)||r.includes(t)||o.includes(t)})):e},bindLockDisplay(){const t=this.bindLock||{},e=t.lock_name||"未命名锁",i=t.lock_mac?` · ${t.lock_mac}`:"";return`${e}（${t.ttlock_lock_id||"-"}）${i}`}},onShow(){this.ensurePermissionAndBootstrap()},methods:{goBack(){t.index$1.navigateBack()},async ensurePermissionAndBootstrap(){const e=r.$store("user"),i=t.index$1.getStorageSync("token");if(i&&!e.isLogin&&e.setToken(i),i||e.isLogin){if(!this.permissionChecked)try{const i=await e.getInfo()||e.userInfo||{};if(1!==Number(i.can_manage_locks))return void t.index$1.showModal({title:"提示",content:"暂无智能门锁管理权限，请联系后台管理员开启。",showCancel:!1,success:()=>t.index$1.navigateBack()});this.permissionChecked=!0}catch(o){return void t.index$1.showToast({title:"获取权限失败，请重试",icon:"none"})}this.status&&void 0!==this.status.config_ok&&this.status.api_base||await this.fetchStatus(),Array.isArray(this.list)&&0!==this.list.length||await this.fetchList(!0)}else t.index$1.reLaunch({url:"/pages/login/login"})},async fetchStatus(){try{const t=await e.ttlockApi.getStatus();if(!t||0!==t.code)return;this.status=t.data||{}}catch(t){}},handleSearch(){},clearKeyword(){this.keyword=""},normalizeBattery(t){const e=Number(t);return!isFinite(e)||e<0?0:e>100?100:Math.round(e)},batteryClass(t){const e=this.normalizeBattery(t);return e<=20?"low":e<=50?"mid":"high"},async onRefresh(){this.refreshing||this.loading||(this.refreshing=!0,await this.fetchStatus(),await this.fetchList(!0),this.refreshing=!1)},async loadMore(){this.loading||this.finished||(this.page+=1,await this.fetchList(!1))},async fetchList(i){if(this.loading)return!1;this.loading=!0;try{i&&(this.page=1,this.finished=!1,this.list=[],this.total=0);const t=await e.ttlockApi.getLockList({page:this.page,pageSize:this.pageSize});if(!t||0!==t.code)return!1;const r=t.data||{},o=Array.isArray(r.items)?r.items:[],s=Number(r.total||0);return this.total=s,this.list=(Array.isArray(this.list)?this.list:[]).concat(o),(this.list.length>=s||0===o.length)&&(this.finished=!0),!0}catch(r){return t.index$1.getStorageSync("token")||t.index$1.reLaunch({url:"/pages/login/login"}),!1}finally{this.loading=!1}},async handleSync(){if(!this.syncing){this.syncing=!0;try{const i=await e.ttlockApi.syncLocks();i&&0===i.code&&(t.index$1.showToast({title:"同步完成",icon:"success"}),await this.onRefresh())}catch(i){}finally{this.syncing=!1}}},openBind(t){t&&t.ttlock_lock_id&&(this.bindLock=t,this.bindVisible=!0,this.propertyKeyword="",this.propertyPage=1,this.propertyFinished=!1,this.propertyList=[],this.searchProperties(!0))},closeBind(){this.bindVisible=!1,this.bindLock=null},clearPropertyKeyword(){this.propertyKeyword="",this.searchProperties(!0)},async searchProperties(t){if(!this.propertyLoading){this.propertyLoading=!0;try{t&&(this.propertyPage=1,this.propertyFinished=!1,this.propertyList=[]);const e=await i.propertyApi.getList({page:this.propertyPage,pageSize:this.propertyPageSize,keyword:String(this.propertyKeyword||"").trim(),category:"all"});if(!e||0!==e.code)return;const r=e.data||{},o=Array.isArray(r.items)?r.items:[],s=Number(r.total||0),n=(Array.isArray(this.propertyList)?this.propertyList:[]).concat(o);this.propertyList=n,(n.length>=s||0===o.length)&&(this.propertyFinished=!0)}catch(e){}finally{this.propertyLoading=!1}}},async loadMoreProperties(){this.propertyLoading||this.propertyFinished||(this.propertyPage+=1,await this.searchProperties(!1))},async selectProperty(i){const r=Number(i&&i.id)||0,o=Number(this.bindLock&&this.bindLock.ttlock_lock_id)||0;if(r&&o)try{const i=await e.ttlockApi.bindProperty({property_id:r,ttlock_lock_id:o});if(!i||0!==i.code)return;t.index$1.showToast({title:"绑定成功",icon:"success"}),this.closeBind(),await this.fetchList(!0)}catch(s){}},confirmUnbind(i){const r=Number(i&&i.bind_property_id)||0;r&&t.index$1.showModal({title:"解绑",content:"确认解绑该房源与智能锁？",success:async i=>{if(i.confirm)try{const i=await e.ttlockApi.unbindProperty({property_id:r});if(!i||0!==i.code)return;t.index$1.showToast({title:"解绑成功",icon:"success"}),await this.fetchList(!0)}catch(o){}}})}}};if(!Array){t.resolveComponent("TopHeader")()}const s=t._export_sfc(o,[["render",function(e,i,r,o,s,n){return t.e({a:t.o(((...t)=>n.goBack&&n.goBack(...t))),b:t.p({title:"智能门锁"}),c:t.o(((...t)=>n.handleSearch&&n.handleSearch(...t))),d:s.keyword,e:t.o((t=>s.keyword=t.detail.value)),f:s.keyword},s.keyword?{g:t.o(((...t)=>n.clearKeyword&&n.clearKeyword(...t)))}:{},{h:t.t(s.status.config_ok?"配置正常":"未配置"),i:s.status.config_ok?1:"",j:t.t(s.status.has_token?"Token有效":"Token缺失"),k:s.status.has_token?1:"",l:s.status.api_base},s.status.api_base?{m:t.t(s.status.api_base)}:{},{n:0===n.filteredLocks.length&&!s.loading},(0!==n.filteredLocks.length||s.loading,{}),{o:t.f(n.filteredLocks,((e,i,r)=>t.e({a:t.t(e.lock_name||"未命名锁"),b:t.t(e.ttlock_lock_id),c:t.t(e.lock_mac||"-"),d:t.t(n.normalizeBattery(e.battery)),e:t.n(n.batteryClass(e.battery)),f:e.bind_property_id},e.bind_property_id?{g:t.t(e.bind_property_title||"房源"),h:t.t(e.bind_property_id),i:t.t(e.bind_property_community_name||"-"),j:t.o((t=>n.confirmUnbind(e)),e.ttlock_lock_id)}:{},{k:t.t(e.bind_property_id?"更换绑定":"绑定房源"),l:t.o((t=>n.openBind(e)),e.ttlock_lock_id),m:e.ttlock_lock_id}))),p:s.loading},(s.loading||s.finished&&s.list.length,{}),{q:s.finished&&s.list.length>0,r:s.refreshing,s:t.o(((...t)=>n.onRefresh&&n.onRefresh(...t))),t:t.o(((...t)=>n.loadMore&&n.loadMore(...t))),v:s.loading?1:"",w:t.o(((...t)=>n.onRefresh&&n.onRefresh(...t))),x:s.syncing?1:"",y:t.o(((...t)=>n.handleSync&&n.handleSync(...t))),z:s.bindVisible},s.bindVisible?t.e({A:t.o(((...t)=>n.closeBind&&n.closeBind(...t))),B:t.t(n.bindLockDisplay),C:t.o((t=>n.searchProperties(!0))),D:s.propertyKeyword,E:t.o((t=>s.propertyKeyword=t.detail.value)),F:s.propertyKeyword},s.propertyKeyword?{G:t.o(((...t)=>n.clearPropertyKeyword&&n.clearPropertyKeyword(...t)))}:{},{H:s.propertyLoading&&0===s.propertyList.length},(s.propertyLoading&&0===s.propertyList.length||s.propertyLoading||s.propertyList.length,{}),{I:!s.propertyLoading&&0===s.propertyList.length,J:t.f(s.propertyList,((e,i,r)=>({a:t.t(e.title||"-"),b:t.t(e.community_name||"-"),c:t.t(e.sale_status_label||"-"),d:e.id,e:t.o((t=>n.selectProperty(e)),e.id)}))),K:s.propertyFinished&&s.propertyList.length>0},(s.propertyFinished&&s.propertyList.length,{}),{L:t.o(((...t)=>n.loadMoreProperties&&n.loadMoreProperties(...t))),M:t.o((()=>{})),N:t.o(((...t)=>n.closeBind&&n.closeBind(...t)))}):{})}]]);wx.createPage(s);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/lock_manage/lock_manage.js.map
