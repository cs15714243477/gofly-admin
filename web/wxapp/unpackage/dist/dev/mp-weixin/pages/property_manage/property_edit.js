"use strict";const e=require("../../common/vendor.js"),i=require("../../api/property.js"),t=require("../../store/index.js"),o=require("../../utils/config/index.js");function a(i=""){const t=(e=>{const i=[];for(let t=0;t<e.length;t++){let o=e.charCodeAt(t);o<128?i.push(o):o<2048?(i.push(192|o>>6),i.push(128|63&o)):(i.push(224|o>>12),i.push(128|o>>6&63),i.push(128|63&o))}return new Uint8Array(i)})(i).buffer;return void 0!==e.wx$1&&e.wx$1.arrayBufferToBase64?e.wx$1.arrayBufferToBase64(t):void 0!==e.index$1&&e.index$1.arrayBufferToBase64?e.index$1.arrayBufferToBase64(t):""}const s={components:{TopHeader:()=>"../../components/TopHeader.js"},data:()=>({id:0,saving:!1,uploading:!1,form:{title:"",price:"",price_unit:"万",area:"",rooms:0,halls:0,bathrooms:0,community_name:"",address:"",latitude:"",longitude:"",tags:[],images:[],cover_image:"",video_url:"",allow_image_download:1,allow_video_download:1,sale_status:"on_sale"},tags:[],images:[],newTag:"",saleStatusOptions:[{label:"在售",value:"on_sale"},{label:"已售",value:"sold"},{label:"下架",value:"off_market"}],priceUnitOptions:["万","元"]}),computed:{saleStatusIndex(){const e=String(this.form.sale_status||"on_sale"),i=this.saleStatusOptions.findIndex((i=>i.value===e));return i>=0?i:0},priceUnitIndex(){const e=String(this.form.price_unit||"万"),i=this.priceUnitOptions.findIndex((i=>i===e));return i>=0?i:0}},onLoad(e){const i=Number(e&&(e.id||e.ID)||0)||0;this.id=i,this.ensurePermission().then((()=>{this.id&&this.loadContent()}))},methods:{goBack(){e.index$1.navigateBack()},async ensurePermission(){const i=t.$store("user");if(!e.index$1.getStorageSync("token")&&!i.isLogin)return void e.index$1.reLaunch({url:"/pages/login/login"});try{i.userInfo&&i.userInfo.id||await i.getInfo()}catch(o){}1===Number((i.userInfo||{}).can_manage_properties)||e.index$1.showModal({title:"提示",content:"暂无房源维护权限，请联系后台管理员开启。",showCancel:!1,success:()=>{e.index$1.navigateBack()}})},onSaleStatusChange(e){const i=Number(e&&e.detail&&e.detail.value)||0,t=this.saleStatusOptions[i]||this.saleStatusOptions[0];this.form.sale_status=t.value},onPriceUnitChange(e){const i=Number(e&&e.detail&&e.detail.value)||0;this.form.price_unit=this.priceUnitOptions[i]||"万"},async loadContent(){const e=await i.propertyApi.getManageContent({id:this.id});if(!e||0!==e.code)return;const t=e.data||{};this.form={...this.form,...t},this.tags=Array.isArray(t.tags)?t.tags:[],this.images=Array.isArray(t.images)?t.images:[],!this.form.cover_image&&this.images.length>0&&(this.form.cover_image=this.images[0])},addTag(){const i=String(this.newTag||"").trim();i?this.tags.includes(i)?this.newTag="":this.tags.length>=6?e.index$1.showToast({title:"最多6个标签",icon:"none"}):(this.tags=this.tags.concat([i]),this.newTag=""):e.index$1.showToast({title:"请输入标签",icon:"none"})},removeTag(e){this.tags=this.tags.filter(((i,t)=>t!==e))},openImageActions(i){const t=this.images[i];if(!t)return;const o=t===this.form.cover_image,a=o?["删除"]:["设为封面","删除"];e.index$1.showActionSheet({itemList:a,success:e=>{const a=Number(e.tapIndex);if(!o&&0===a)return void(this.form.cover_image=t);a===(o?0:1)&&(this.images=this.images.filter(((e,t)=>t!==i)),this.form.cover_image===t&&(this.form.cover_image=this.images[0]||""))}})},openVideoActions(){const i=!!this.form.video_url,t=i?["更换视频","移除视频"]:["上传视频"];e.index$1.showActionSheet({itemList:t,success:async e=>{const t=Number(e.tapIndex);i?(0===t&&await this.pickVideo(),1===t&&(this.form.video_url="")):await this.pickVideo()}})},pickImages(){this.uploading||e.index$1.chooseImage({count:9,sizeType:["compressed"],sourceType:["album","camera"],success:async e=>{const i=e&&e.tempFilePaths||[];i.length&&await this.uploadFiles(i,"image")}})},pickVideo(){return this.uploading?Promise.resolve():new Promise((i=>{e.index$1.chooseVideo({sourceType:["album","camera"],maxDuration:60,compressed:!0,success:async e=>{var t;const o=e&&(e.tempFilePath||(null==(t=e.tempFilePaths)?void 0:t[0]));if(!o)return i();await this.uploadFiles([o],"video"),i()},fail:()=>i()})}))},uploadFiles(i=[],t="image"){return Array.isArray(i)&&0!==i.length?new Promise((async o=>{this.uploading=!0,e.index$1.showLoading({title:"上传中",mask:!0});try{for(let e=0;e<i.length;e++){const o=i[e],a=await this.uploadSingle(o,t).catch((()=>null)),s=a&&0===a.code&&a.data?a.data.url:"";s&&("video"===t?this.form.video_url=s:(this.images=this.images.concat([s]),this.form.cover_image||(this.form.cover_image=s)))}}finally{e.index$1.hideLoading(),this.uploading=!1,o()}})):Promise.resolve()},uploadSingle:(i,t)=>new Promise(((s,n)=>{const r=e.index$1.getStorageSync("token"),l=Math.floor(Date.now()/1e3),d={Accept:"text/json",Businessid:"1",apiverify:a(e.md5("gofly@888"+l)+"#"+l)};r&&(d.Authorization=`${r}`),e.index$1.uploadFile({url:`${o.baseUrl}/common/upload/upFile`,filePath:i,name:"file",formData:{filetype:t},header:d,success:i=>{try{const t=i&&i.data?i.data:"{}",o="string"==typeof t?JSON.parse(t):t;if(!o||0!==o.code)return e.index$1.showToast({title:o&&o.message||"上传失败",icon:"none"}),void n(o);s(o)}catch(t){e.index$1.showToast({title:"解析上传结果失败",icon:"none"}),n(t)}},fail:i=>{e.index$1.showToast({title:"上传失败",icon:"none"}),n(i)}})})),pickLocation(){e.index$1.chooseLocation({success:e=>{if(!e)return;const i=Number(e.latitude),t=Number(e.longitude);isFinite(i)&&isFinite(t)&&(this.form.latitude=i,this.form.longitude=t),e.name&&!this.form.community_name&&(this.form.community_name=String(e.name)),e.address&&(this.form.address=String(e.address))},fail:()=>{e.index$1.showToast({title:"无法打开地图",icon:"none"})}})},async save(){if(this.saving||this.uploading)return;const t=String(this.form.title||"").trim();if(t){this.saving=!0;try{const o={...this.id?{id:this.id}:{},title:t,sale_status:this.form.sale_status,price:this.form.price,price_unit:this.form.price_unit,area:this.form.area,rooms:Number(this.form.rooms||0),halls:Number(this.form.halls||0),bathrooms:Number(this.form.bathrooms||0),community_name:String(this.form.community_name||"").trim(),address:String(this.form.address||"").trim(),latitude:this.form.latitude||"",longitude:this.form.longitude||"",tags:this.tags,images:this.images,cover_image:this.form.cover_image||"",video_url:this.form.video_url||"",allow_image_download:1===Number(this.form.allow_image_download)?1:0,allow_video_download:1===Number(this.form.allow_video_download)?1:0},a=await i.propertyApi.saveManage(o);if(!a||0!==a.code)return;const s=Number(a&&a.data&&a.data.id)||0;!this.id&&s&&(this.id=s),e.index$1.showToast({title:"保存成功",icon:"none"})}finally{this.saving=!1}}else e.index$1.showToast({title:"请填写房源标题",icon:"none"})},preview(){this.id&&e.index$1.navigateTo({url:`/pages/property_detail/property_detail?id=${this.id}`})}}};if(!Array){e.resolveComponent("TopHeader")()}const n=e._export_sfc(s,[["render",function(i,t,o,a,s,n){var r;return e.e({a:e.o(((...e)=>n.goBack&&n.goBack(...e))),b:e.o(((...e)=>n.save&&n.save(...e))),c:e.p({title:s.id?"编辑房源":"新增房源"}),d:s.form.title,e:e.o((e=>s.form.title=e.detail.value)),f:e.t((null==(r=s.saleStatusOptions[n.saleStatusIndex])?void 0:r.label)||"请选择"),g:s.saleStatusOptions.map((e=>e.label)),h:n.saleStatusIndex,i:e.o(((...e)=>n.onSaleStatusChange&&n.onSaleStatusChange(...e))),j:s.form.price,k:e.o((e=>s.form.price=e.detail.value)),l:e.t(s.form.price_unit||"万"),m:s.priceUnitOptions,n:n.priceUnitIndex,o:e.o(((...e)=>n.onPriceUnitChange&&n.onPriceUnitChange(...e))),p:s.form.area,q:e.o((e=>s.form.area=e.detail.value)),r:s.form.rooms,s:e.o((e=>s.form.rooms=e.detail.value)),t:s.form.halls,v:e.o((e=>s.form.halls=e.detail.value)),w:s.form.bathrooms,x:e.o((e=>s.form.bathrooms=e.detail.value)),y:e.f(s.images,((i,t,o)=>e.e({a:i,b:i===s.form.cover_image},(s.form.cover_image,{}),{c:"img-"+t,d:e.o((e=>n.openImageActions(t)),"img-"+t)}))),z:e.o(((...e)=>n.pickImages&&n.pickImages(...e))),A:1===Number(s.form.allow_image_download),B:e.o((e=>s.form.allow_image_download=e.detail.value?1:0)),C:!s.form.video_url},s.form.video_url?{D:s.form.video_url}:{},{E:e.o(((...e)=>n.openVideoActions&&n.openVideoActions(...e))),F:1===Number(s.form.allow_video_download),G:e.o((e=>s.form.allow_video_download=e.detail.value?1:0)),H:e.f(s.tags,((i,t,o)=>({a:e.t(i),b:e.o((e=>n.removeTag(t)),"t-"+t),c:"t-"+t}))),I:0===s.tags.length},(s.tags.length,{}),{J:s.newTag,K:e.o((e=>s.newTag=e.detail.value)),L:e.o(((...e)=>n.addTag&&n.addTag(...e))),M:s.form.community_name,N:e.o((e=>s.form.community_name=e.detail.value)),O:s.form.address,P:e.o((e=>s.form.address=e.detail.value)),Q:e.t(s.form.latitude&&s.form.longitude?Number(s.form.latitude).toFixed(6)+", "+Number(s.form.longitude).toFixed(6):"未选择坐标"),R:e.o(((...e)=>n.pickLocation&&n.pickLocation(...e))),S:!s.id,T:e.o(((...e)=>n.preview&&n.preview(...e))),U:e.t(s.saving?"保存中...":"保存"),V:e.o(((...e)=>n.save&&n.save(...e)))})}]]);wx.createPage(n);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/property_manage/property_edit.js.map
