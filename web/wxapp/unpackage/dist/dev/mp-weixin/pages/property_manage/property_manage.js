"use strict";const e=require("../../common/vendor.js"),t=require("../../store/index.js"),a=require("../../api/property.js"),s={components:{TopHeader:()=>"../../components/TopHeader.js"},data:()=>({fallbackCover:"/static/images/img_cdc09ae543.png",loading:!1,finished:!1,page:1,pageSize:10,total:0,list:[],keyword:"",saleStatus:"",saleStatusTabs:[{label:"全部",value:""},{label:"在售",value:"on_sale"},{label:"已售",value:"sold"},{label:"下架",value:"off_market"}],inited:!1}),onShow(){this.ensurePermissionAndLoad()},methods:{ensureTags:e=>Array.isArray(e)?e:e?String(e).split(",").map((e=>String(e||"").trim())).filter(Boolean):[],statusPillClass(e){const t=String(e&&e.sale_status);return"sold"===t?"sold":"off_market"===t?"off":"on"},toggleBtnClass(e){const t=String(e&&e.sale_status);return"sold"===t?"disabled":"off_market"===t?"primary":"warn"},async ensurePermissionAndLoad(){const a=t.$store("user");if(!e.index$1.getStorageSync("token")&&!a.isLogin)return void e.index$1.reLaunch({url:"/pages/login/login"});try{a.userInfo&&a.userInfo.id||await a.getInfo();const e=a.userInfo||{};e.id&&void 0===e.can_manage_properties&&await a.getInfo()}catch(o){}const s=a.userInfo||{},i=1===Number(s.can_manage_properties);this.currentUserId=Number(s.id||0)||0,i?(this.inited||(this.inited=!0),this.reload()):e.index$1.showModal({title:"提示",content:"暂无房源维护权限，请联系后台管理员开启。",showCancel:!1,success:()=>{e.index$1.navigateBack()}})},goBack(){e.index$1.navigateBack()},goAdd(){e.index$1.navigateTo({url:"/pages/property_manage/property_edit"})},goEdit(t){const a=Number(t&&t.id)||0;a&&e.index$1.navigateTo({url:`/pages/property_manage/property_edit?id=${a}`})},goDetail(t){const a=Number(t&&t.id)||0;a&&e.index$1.navigateTo({url:`/pages/property_detail/property_detail?id=${a}`})},clearKeyword(){this.keyword="",this.reload()},onSearchConfirm(){this.reload()},onSaleStatus(e){this.saleStatus=e,this.reload()},async reload(){this.loading||(this.page=1,this.total=0,this.list=[],this.finished=!1,await this.fetchList())},async loadMore(){await this.fetchList()},async fetchList(){if(!this.loading&&!this.finished){this.loading=!0;try{const t=await a.propertyApi.getManageList({page:this.page,pageSize:this.pageSize,keyword:String(this.keyword||"").trim(),sale_status:this.saleStatus});if(!t||0!==t.code)return void(t&&403===Number(t.code)&&e.index$1.showToast({title:"暂无权限",icon:"none"}));const s=t.data||{},i=Array.isArray(s.items)?s.items:[],o=Number(s.total||0);this.total=o,1===this.page?this.list=i:this.list=this.list.concat(i),0===i.length||o>0&&this.list.length>=o?this.finished=!0:this.page+=1}finally{this.loading=!1}}},confirmDelete(t){const s=Number(t&&t.id)||0;s&&e.index$1.showModal({title:"确认删除",content:"确定要删除该房源吗？（软删除，可在后台恢复）",confirmText:"删除",confirmColor:"#ef4444",success:async t=>{if(!t.confirm)return;const i=await a.propertyApi.delManage({id:s});i&&0===i.code&&(e.index$1.showToast({title:"已删除",icon:"none"}),this.reload())}})},confirmToggleSaleStatus(t){const s=Number(t&&t.id)||0;if(!s)return;const i=String(t&&t.sale_status);if("sold"===i)return;const o="off_market"===i?"on_sale":"off_market",n="on_sale"===o?"上架":"下架";e.index$1.showModal({title:"确认操作",content:`确定要${n}该房源吗？`,confirmText:n,success:async t=>{if(!t.confirm)return;const i=await a.propertyApi.saveManage({id:s,sale_status:o});i&&0===i.code&&(e.index$1.showToast({title:"已更新",icon:"none"}),this.reload())}})}}};if(!Array){e.resolveComponent("TopHeader")()}const i=e._export_sfc(s,[["render",function(t,a,s,i,o,n){return e.e({a:e.o(((...e)=>n.goBack&&n.goBack(...e))),b:e.p({title:"房源管理"}),c:e.o(((...e)=>n.onSearchConfirm&&n.onSearchConfirm(...e))),d:o.keyword,e:e.o((e=>o.keyword=e.detail.value)),f:o.keyword},o.keyword?{g:e.o(((...e)=>n.clearKeyword&&n.clearKeyword(...e)))}:{},{h:e.f(o.saleStatusTabs,((t,a,s)=>({a:e.t(t.label),b:a,c:o.saleStatus===t.value?1:"",d:e.o((e=>n.onSaleStatus(t.value)),a)}))),i:e.f(o.list,((t,a,s)=>({a:t.image||o.fallbackCover,b:e.t(t.sale_status_label||"-"),c:e.n(n.statusPillClass(t)),d:e.t(t.title||"-"),e:e.t(t.price||"-"),f:e.t(t.price_unit||""),g:e.t((t.rooms||0)+"室"+(t.halls||0)+"厅"),h:e.t(t.area||"-"),i:e.f(n.ensureTags(t.tags).slice(0,4),((t,a,s)=>({a:e.t(t),b:a}))),j:e.t((t.community_name||"")+(t.address?" · "+t.address:"")),k:e.o((e=>n.goDetail(t)),t.id||a),l:e.o((e=>n.goEdit(t)),t.id||a),m:e.o((e=>n.confirmDelete(t)),t.id||a),n:e.t("off_market"===String(t.sale_status)?"publish":"unpublished"),o:e.t("sold"===String(t.sale_status)?"已售":"off_market"===String(t.sale_status)?"上架":"下架"),p:e.n(n.toggleBtnClass(t)),q:e.o((e=>n.confirmToggleSaleStatus(t)),t.id||a),r:"sold"===String(t.sale_status),s:t.id||a}))),j:!o.loading&&0===o.list.length},(o.loading||o.list.length,{}),{k:o.loading},(o.loading||o.finished&&o.list.length,{}),{l:o.finished&&o.list.length>0,m:e.o(((...e)=>n.loadMore&&n.loadMore(...e))),n:e.o(((...e)=>n.goAdd&&n.goAdd(...e)))})}]]);wx.createPage(i);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/property_manage/property_manage.js.map
