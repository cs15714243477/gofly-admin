"use strict";const e=require("../../common/vendor.js"),t=require("../../api/property.js"),i=require("../../common/assets.js"),o={data:()=>({propertyId:0,loading:!1,property:{},statusBarHeight:0,headerTop:0,headerOpacity:0,currentSwiper:0,isFollowed:!1,hasSmartLock:!1,ownerPhone:"",images:["/static/images/img_cdc09ae543.png","/static/images/img_cdc09ae543.png"],bannerItems:[{type:"image",src:"/static/images/img_cdc09ae543.png"},{type:"image",src:"/static/images/img_cdc09ae543.png"}],videoUrl:"",videoPoster:"/static/images/img_cdc09ae543.png",allowImageDownload:!0,allowVideoDownload:!0,mapLat:0,mapLng:0,mapMarkers:[],attributes:[{label:"单价",value:"9,086元/m²"},{label:"楼层",value:"中层 / 共32层"},{label:"朝向",value:"南北通透"},{label:"装修",value:"精装修"},{label:"年代",value:"2019年建"},{label:"产权",value:"商品房"}],renovationTabs:[{key:"none",label:"未装修"},{key:"in_progress",label:"进行中"},{key:"done",label:"已完成"}],renovation:{status:"in_progress",subtitle:"高端精装，环保材料（示例）",progress:68,stage:"水电验收完成，正在进行泥木施工",eta:"预计 2026-02-20",finishAt:"2026-01-10",materials:["圣象地板","马可波罗瓷砖","多乐士乳胶漆"],note:"客厅墙面已完成找平与底漆，卫生间防水已做闭水试验；全屋线管/强弱电分离施工完成。",images:["/static/images/img_08b712f810.png","/static/images/img_8642388cea.png"]},recommends:[{name:"阳光花园三期 2室",rooms:"2室1厅",price:"72万",size:"89",image:"/static/images/img_71f4809787.png"},{name:"金地名津 精装大三房",rooms:"3室2厅",price:"98万",size:"96",image:"/static/images/img_1112597ba0.png"},{name:"万科四季花城",rooms:"3室2厅",price:"105万",size:"110",image:"/static/images/img_662c3c598a.png"}]}),onLoad(t){const i=e.index$1.getSystemInfoSync();this.statusBarHeight=i.statusBarHeight;try{if(void 0!==e.wx$1&&e.wx$1.getMenuButtonBoundingClientRect){const t=e.wx$1.getMenuButtonBoundingClientRect(),o=Number(i.windowWidth||375),r=80*(o/750),a=Number(t.top||0)+Number(t.height||0)/2-r/2;this.headerTop=Math.max(Number(this.statusBarHeight||0),Math.round(a))}else this.headerTop=this.statusBarHeight+12}catch(r){this.headerTop=this.statusBarHeight+12}const o=Number(t&&(t.id||t.ID||t.property_id))||0;this.propertyId=o,this.propertyId?this.loadDetail():e.index$1.showToast({title:"房源ID缺失",icon:"none"})},computed:{showDownloadBtn(){const e=this.getCurrentBannerItem();return!!e&&("video"===e.type?!!this.allowVideoDownload:"image"===e.type&&!!this.allowImageDownload)},downloadLabel(){const e=this.getCurrentBannerItem();return e?"video"===e.type?"下载视频":"下载图片":"下载"},hasLocation(){const e=Number(this.mapLat),t=Number(this.mapLng);return!!e&&!!t&&isFinite(e)&&isFinite(t)}},methods:{tagClass(e){const t=String(e||"").trim();return t&&(t.includes("急售")||t.includes("降价"))?"orange":""},getLayoutText(e){const t=Number(e&&e.rooms)||0,i=Number(e&&e.halls)||0,o=Number(e&&e.bathrooms)||0;if(!t&&!i&&!o)return"-";let r="";return t&&(r+=`${t}室`),i&&(r+=`${i}厅`),o&&(r+=`${o}卫`),r||"-"},getUnitPriceText(e){const t=Number(e&&e.price),i=Number(e&&e.area);if(!t||!i)return"-";let o=t;"万"===(e&&e.price_unit||"")&&(o=1e4*t);const r=o/i;return r&&isFinite(r)?`${Math.round(r).toLocaleString()}元/㎡`:"-"},buildAttributes(e){const t=[];t.push({label:"单价",value:this.getUnitPriceText(e)});const i=String(e&&e.floor_level||"").trim(),o=Number(e&&e.total_floors)||0;(i||o)&&t.push({label:"楼层",value:`${i||"-"}${o?` / 共${o}层`:""}`}),t.push({label:"朝向",value:e&&e.orientation?e.orientation:"-"}),t.push({label:"装修",value:e&&e.decoration_type?e.decoration_type:"-"});const r=Number(e&&e.build_year)||0;return t.push({label:"年代",value:r?`${r}年建`:"-"}),t.push({label:"物业类型",value:e&&e.property_type?e.property_type:"-"}),t},getCommissionText(e){const t=String(e&&e.commission_rate||"").trim(),i=String(e&&e.commission_reward||"").trim(),o=!!t&&"0"!==t&&"0.0"!==t&&"0.00"!==t,r=!!i&&"0"!==i&&"0.0"!==i&&"0.00"!==i;return o&&r?`佣金${t}% ，成交奖励￥${i}`:o?`佣金${t}%`:r?`成交奖励￥${i}`:"佣金待定"},mapPinText(){const e=String(this.property&&this.property.community_name||"").trim(),t=String(this.property&&this.property.address||"").trim();return e&&t?`${e} · ${t}`:e||t||"暂无位置信息"},async loadDetail(){if(this.loading||!this.propertyId)return!1;let i;this.loading=!0;try{i=await t.propertyApi.getDetail({id:this.propertyId})}catch(h){return this.loading=!1,e.index$1.getStorageSync("token")||e.index$1.reLaunch({url:"/pages/login/login"}),!1}if(this.loading=!1,!i||0!==i.code)return setTimeout((()=>{e.index$1.navigateBack()}),600),!1;const o=i.data||{},r=o.property||{};if(!r||!r.id)return setTimeout((()=>{e.index$1.navigateBack()}),600),!1;this.property=r,this.isFollowed=!!o.is_followed,this.hasSmartLock=1===Number(r.has_smart_lock),this.ownerPhone=String(r.owner_phone||"").trim(),this.allowImageDownload=0!==Number(r.allow_image_download),this.allowVideoDownload=0!==Number(r.allow_video_download),this.videoUrl=String(r.video_url||"").trim(),this.videoPoster=String(r.cover_image||"").trim();const a=Array.isArray(o.images)?o.images:Array.isArray(r.images)?r.images:[];a.length>0&&(this.images=a),this.currentSwiper=0;const n=[];this.videoUrl&&n.push({type:"video",src:this.videoUrl}),(this.images||[]).forEach((e=>n.push({type:"image",src:e}))),this.bannerItems=n;const s=Number(r.latitude),l=Number(r.longitude);this.mapLat=isFinite(s)?s:0,this.mapLng=isFinite(l)?l:0,this.mapMarkers=this.mapLat&&this.mapLng?[{id:1,latitude:this.mapLat,longitude:this.mapLng,width:26,height:26}]:[],this.attributes=this.buildAttributes(r);const p=o.renovation||{},d=String(p.renovation_status||"").trim();let c="none";"in_progress"===d||"done"===d||"none"===d?c=d:"1"===d?c="in_progress":"2"===d&&(c="done"),this.renovation={status:c,subtitle:String(p.subtitle||"房源装修情况").trim()||"房源装修情况",progress:Number(p.progress_percentage||0)||0,stage:String(p.current_stage||"").trim()||"—",eta:String(p.estimated_finish_date||"").trim()||"—",finishAt:String(p.actual_finish_date||"").trim()||"—",materials:Array.isArray(p.materials)?p.materials:[],note:String(p.notes||"").trim()||"—",images:Array.isArray(p.images)?p.images:[]};const m=Array.isArray(o.recommends)?o.recommends:[];return this.recommends=m.map((e=>({id:e.id,name:e.title||e.name||"房源",rooms:this.getLayoutText(e),price:`${e.price||"-"}${e.price_unit||""}`,size:e.area||"-",image:e.image||""}))),!0},onPageScroll(e){const t=Number(e&&e.detail&&e.detail.scrollTop||0),i=Math.min(1,t/160);this.headerOpacity=Math.max(0,Math.min(1,Number(i.toFixed(3))))},goBack(){e.index$1.navigateBack()},goToRec(t){const i=Number(t&&(t.id||t.ID))||0;i&&i!==this.propertyId&&e.index$1.redirectTo({url:`/pages/property_detail/property_detail?id=${encodeURIComponent(i)}`})},swiperChange(e){this.currentSwiper=e.detail.current},getCurrentBannerItem(){return(Array.isArray(this.bannerItems)?this.bannerItems:[])[Number(this.currentSwiper)||0]||null},ensureAlbumPermission:()=>new Promise(((t,i)=>{e.index$1.getSetting({success:o=>{if(o&&o.authSetting&&o.authSetting["scope.writePhotosAlbum"])return t(!0);e.index$1.authorize({scope:"scope.writePhotosAlbum",success:()=>t(!0),fail:()=>{e.index$1.showModal({title:"需要相册权限",content:"保存到相册需要授权，请在设置中开启相册权限。",confirmText:"去设置",success:o=>{o.confirm?e.index$1.openSetting({success:()=>t(!0),fail:()=>i(!1)}):i(!1)}})}})},fail:()=>i(!1)})})),async downloadCurrent(){const t=this.getCurrentBannerItem();if(!t)return;if("video"===t.type&&!this.allowVideoDownload)return;if("image"===t.type&&!this.allowImageDownload)return;try{await this.ensureAlbumPermission()}catch(o){return}const i=String(t.src||"").trim();i&&(e.index$1.showLoading({title:"下载中..."}),e.index$1.downloadFile({url:i,success:i=>{const o=i&&i.tempFilePath;if(!o)return e.index$1.hideLoading(),void e.index$1.showToast({title:"下载失败",icon:"none"});"video"===t.type?e.index$1.saveVideoToPhotosAlbum({filePath:o,success:()=>e.index$1.showToast({title:"已保存视频",icon:"success"}),fail:()=>e.index$1.showToast({title:"保存失败",icon:"none"}),complete:()=>e.index$1.hideLoading()}):e.index$1.saveImageToPhotosAlbum({filePath:o,success:()=>e.index$1.showToast({title:"已保存图片",icon:"success"}),fail:()=>e.index$1.showToast({title:"保存失败",icon:"none"}),complete:()=>e.index$1.hideLoading()})},fail:()=>{e.index$1.hideLoading(),e.index$1.showToast({title:"下载失败",icon:"none"})}}))},handleShare(){const t=this.property&&this.property.title?this.property.title:"房源",i=this.propertyId;e.index$1.showActionSheet({itemList:["生成获客海报","复制房源链接","模拟分享（占位）"],success:o=>{if(0!==o.tapIndex)if(1!==o.tapIndex)2===o.tapIndex&&e.index$1.showToast({title:"分享功能待接入",icon:"none"});else{const o=i?`/pages/property_detail/property_detail?id=${encodeURIComponent(i)}`:"/pages/property_detail/property_detail";e.index$1.setClipboardData({data:`${t}\n${o}`,success:()=>e.index$1.showToast({title:"已复制链接",icon:"none"})})}else e.index$1.navigateTo({url:`/pages/marketing_posters/marketing_posters?title=${encodeURIComponent(t)}`})}})},openMap(){const t=Number(this.property&&this.property.latitude),i=Number(this.property&&this.property.longitude),o=String(this.property&&(this.property.community_name||this.property.title)||"房源").trim(),r=String(this.property&&this.property.address||"").trim();t&&i&&isFinite(t)&&isFinite(i)?e.index$1.openLocation({latitude:t,longitude:i,name:o,address:r||o,fail:()=>{e.index$1.showToast({title:"无法打开地图",icon:"none"})}}):e.index$1.showToast({title:"暂无定位信息",icon:"none"})},async toggleFollow(){if(!this.propertyId)return;let i;try{i=await t.propertyApi.toggleFollow({id:this.propertyId})}catch(r){return void(e.index$1.getStorageSync("token")||e.index$1.reLaunch({url:"/pages/login/login"}))}if(!i||0!==i.code)return;const o=i.data||{};this.isFollowed=!!o.is_followed,this.property&&(this.property.follow_count=o.follow_count),e.index$1.showToast({title:this.isFollowed?"已关注":"已取消关注",icon:"none"})},callOwner(){this.ownerPhone?e.index$1.makePhoneCall({phoneNumber:this.ownerPhone}):e.index$1.showToast({title:"暂无业主电话",icon:"none"})},openLock(){const t=String(this.property&&this.property.sale_status||"").trim();if("sold"!==t&&"off_market"!==t)e.index$1.navigateTo({url:this.hasSmartLock?"/pages/unlock_steps/unlock_steps":"/pages/unlock_details/unlock_details"});else{const t=this.property&&this.property.sale_status_label?this.property.sale_status_label:"不可操作";e.index$1.showToast({title:`房源${t}，暂不可开锁`,icon:"none"})}},setRenovationStatus(e){}}};const r=e._export_sfc(o,[["render",function(t,o,r,a,n,s){return e.e({a:1-n.headerOpacity,b:n.headerOpacity,c:n.headerOpacity>.65?1:"",d:e.o(((...e)=>s.goBack&&s.goBack(...e))),e:n.headerTop+"px",f:e.f(n.bannerItems,((t,i,o)=>e.e({a:"video"===t.type},"video"===t.type?{b:t.src,c:n.videoPoster}:{d:t.src},{e:i}))),g:e.o(((...e)=>s.swiperChange&&s.swiperChange(...e))),h:s.showDownloadBtn},s.showDownloadBtn?{i:e.t(s.downloadLabel),j:e.o(((...e)=>s.downloadCurrent&&s.downloadCurrent(...e)))}:{},{k:e.t(n.bannerItems.length?n.currentSwiper+1:0),l:e.t(n.bannerItems.length),m:e.t(n.property&&n.property.title||"-"),n:e.o(((...e)=>s.handleShare&&s.handleShare(...e))),o:e.f((n.property&&n.property.tags||[]).slice(0,6),((t,i,o)=>({a:e.t(t),b:i,c:e.n(s.tagClass(t))}))),p:e.t(n.property&&n.property.price||"-"),q:e.t(n.property&&n.property.price_unit||""),r:e.t(s.getLayoutText(n.property)),s:e.t(n.property&&n.property.area||"-"),t:e.t(s.getCommissionText(n.property)),v:e.t(n.property&&n.property.view_count||0),w:e.t(n.property&&n.property.follow_count||0),x:e.t(n.property&&n.property.showing_count||0),y:e.f(n.attributes,((t,i,o)=>({a:e.t(t.label),b:e.t(t.value),c:i}))),z:e.f(n.renovationTabs,((t,i,o)=>({a:e.t(t.label),b:t.key,c:n.renovation.status===t.key?1:"",d:e.o((e=>s.setRenovationStatus(t.key)),t.key)}))),A:e.t("none"===n.renovation.status?"未装修":"in_progress"===n.renovation.status?"装修进行中":"装修完成"),B:e.n(n.renovation.status),C:e.t(n.renovation.subtitle),D:"none"===n.renovation.status},"none"===n.renovation.status?{}:"in_progress"===n.renovation.status?{F:e.f(n.renovation.images,((e,t,i)=>({a:e,b:t}))),G:n.renovation.progress+"%",H:e.t(n.renovation.progress),I:e.t(n.renovation.stage),J:e.t(n.renovation.eta),K:e.f(n.renovation.materials,((t,i,o)=>({a:e.t(t),b:"m-"+i}))),L:e.t(n.renovation.note)}:{M:e.t(n.renovation.finishAt),N:e.f(n.renovation.materials,((t,i,o)=>({a:e.t(t),b:"dm-"+i}))),O:e.t(n.renovation.note)},{E:"in_progress"===n.renovation.status,P:e.o(((...e)=>s.openMap&&s.openMap(...e))),Q:s.hasLocation},s.hasLocation?{R:n.mapLat,S:n.mapLng,T:n.mapMarkers,U:e.o(((...e)=>s.openMap&&s.openMap(...e)))}:{V:i._imports_0},{W:e.t(s.mapPinText()),X:s.hasLocation},s.hasLocation?{Y:e.t(n.mapLng.toFixed(6)),Z:e.t(n.mapLat.toFixed(6))}:{},{aa:e.o(((...e)=>s.openMap&&s.openMap(...e))),ab:e.f(n.recommends,((t,i,o)=>({a:t.image,b:e.t(t.size),c:e.t(t.name),d:e.t(t.rooms),e:e.t(t.price),f:i,g:e.o((e=>s.goToRec(t)),i)}))),ac:e.o(((...e)=>s.onPageScroll&&s.onPageScroll(...e))),ad:e.o(((...e)=>s.callOwner&&s.callOwner(...e))),ae:n.isFollowed},(n.isFollowed,{}),{af:e.o(((...e)=>s.toggleFollow&&s.toggleFollow(...e))),ag:n.hasSmartLock},(n.hasSmartLock,{}),{ah:e.t(n.hasSmartLock?"智能锁":"密码开锁"),ai:e.o(((...e)=>s.openLock&&s.openLock(...e)))})}]]);o.__runtimeHooks=1,wx.createPage(r);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/property_detail/property_detail.js.map
