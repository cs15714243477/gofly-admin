"use strict";const e=require("../../common/vendor.js"),t=require("../../api/property.js"),r=require("../../store/index.js"),i=require("../../common/assets.js"),o={data:()=>({propertyId:0,loading:!1,property:{},currentUserId:0,canManageProperties:!1,statusBarHeight:0,headerTop:0,headerPadLeftPx:0,headerPadRightPx:0,headerOpacity:0,currentSwiper:0,isFollowed:!1,hasSmartLock:!1,ownerPhone:"",images:["/static/images/img_cdc09ae543.png","/static/images/img_cdc09ae543.png"],bannerItems:[{type:"image",src:"/static/images/img_cdc09ae543.png"},{type:"image",src:"/static/images/img_cdc09ae543.png"}],videoUrl:"",videoPoster:"/static/images/img_cdc09ae543.png",allowImageDownload:!0,allowVideoDownload:!0,mapLat:0,mapLng:0,mapMarkers:[],attributes:[{label:"单价",value:"9,086元/m²"},{label:"楼层",value:"中层 / 共32层"},{label:"朝向",value:"南北通透"},{label:"装修",value:"精装修"},{label:"年代",value:"2019年建"},{label:"产权",value:"商品房"}],renovationTabs:[{key:"none",label:"未装修"},{key:"in_progress",label:"进行中"},{key:"done",label:"已完成"}],renovation:{status:"in_progress",subtitle:"高端精装，环保材料（示例）",progress:68,stage:"水电验收完成，正在进行泥木施工",eta:"预计 2026-02-20",finishAt:"2026-01-10",materials:["圣象地板","马可波罗瓷砖","多乐士乳胶漆"],note:"客厅墙面已完成找平与底漆，卫生间防水已做闭水试验；全屋线管/强弱电分离施工完成。",images:["/static/images/img_08b712f810.png","/static/images/img_8642388cea.png"]},recommends:[{name:"阳光花园三期 2室",rooms:"2室1厅",price:"72万",size:"89",image:"/static/images/img_71f4809787.png"},{name:"金地名津 精装大三房",rooms:"3室2厅",price:"98万",size:"96",image:"/static/images/img_1112597ba0.png"},{name:"万科四季花城",rooms:"3室2厅",price:"105万",size:"110",image:"/static/images/img_662c3c598a.png"}]}),onLoad(t){const r=e.index$1.getSystemInfoSync();this.statusBarHeight=r.statusBarHeight;try{if(void 0!==e.wx$1&&e.wx$1.getMenuButtonBoundingClientRect){const t=e.wx$1.getMenuButtonBoundingClientRect(),i=Number(r.windowWidth||375),o=i/750,a=Math.round(32*o),n=Math.max(0,i-Number(t.left||0));this.headerPadLeftPx=a,this.headerPadRightPx=a+n;const s=80*o,p=Number(t.top||0)+Number(t.height||0)/2-s/2;this.headerTop=Math.max(Number(this.statusBarHeight||0),Math.round(p))}else this.headerTop=this.statusBarHeight+12}catch(o){this.headerTop=this.statusBarHeight+12}const i=Number(t&&(t.id||t.ID||t.property_id))||0;this.propertyId=i,this.propertyId?(this.ensureCanManageProperties(),this.loadDetail()):e.index$1.showToast({title:"房源ID缺失",icon:"none"})},computed:{canEditThisProperty(){if(!this.canManageProperties)return!1;if(!(Number(this.propertyId||0)||0))return!1;const e=Number(this.property&&this.property.agent_id)||0,t=Number(this.currentUserId||0)||0;return!(!t||!e)&&e===t},showDownloadBtn(){const e=this.getCurrentBannerItem();return!!e&&("video"===e.type?!!this.allowVideoDownload:"image"===e.type&&!!this.allowImageDownload)},downloadLabel(){const e=this.getCurrentBannerItem();return e?"video"===e.type?"下载视频":"下载图片":"下载"},hasLocation(){const e=Number(this.mapLat),t=Number(this.mapLng);return!!e&&!!t&&isFinite(e)&&isFinite(t)}},methods:{async ensureCanManageProperties(){const t=r.$store("user");if(!e.index$1.getStorageSync("token")&&!t.isLogin)return this.canManageProperties=!1,void(this.currentUserId=0);try{const e=t.userInfo||{};e.id&&void 0!==e.can_manage_properties||await t.getInfo()}catch(o){}const i=t.userInfo||{};this.currentUserId=Number(i.id||0)||0,this.canManageProperties=1===Number(i.can_manage_properties);try{e.index$1.__f__("log","at pages/property_detail/property_detail.vue:704","[property_detail] perm",{id:this.currentUserId,can_manage_properties:i.can_manage_properties})}catch(o){}},goEdit(){this.propertyId&&e.index$1.navigateTo({url:`/pages/property_manage/property_edit?id=${this.propertyId}`})},debugEditState(){try{const t=Number(this.currentUserId||0)||0,r=!!this.canManageProperties,i=Number(this.property&&this.property.agent_id)||0,o=!!this.canEditThisProperty;e.index$1.showModal({title:"编辑按钮诊断",content:["can_manage_properties: "+(r?1:0),`currentUserId: ${t}`,`property.agent_id: ${i}`,"canEditThisProperty: "+(o?1:0),o?"✅ 满足条件应显示":"❌ 条件不满足所以不显示"].join("\n"),showCancel:!1})}catch(t){}},tagClass(e){const t=String(e||"").trim();return t&&(t.includes("急售")||t.includes("降价"))?"orange":""},getLayoutText(e){const t=Number(e&&e.rooms)||0,r=Number(e&&e.halls)||0,i=Number(e&&e.bathrooms)||0;if(!t&&!r&&!i)return"-";let o="";return t&&(o+=`${t}室`),r&&(o+=`${r}厅`),i&&(o+=`${i}卫`),o||"-"},getUnitPriceText(e){const t=Number(e&&e.price),r=Number(e&&e.area);if(!t||!r)return"-";let i=t;"万"===(e&&e.price_unit||"")&&(i=1e4*t);const o=i/r;return o&&isFinite(o)?`${Math.round(o).toLocaleString()}元/㎡`:"-"},buildAttributes(e){const t=[];t.push({label:"单价",value:this.getUnitPriceText(e)});const r=String(e&&e.floor_level||"").trim(),i=Number(e&&e.total_floors)||0;(r||i)&&t.push({label:"楼层",value:`${r||"-"}${i?` / 共${i}层`:""}`}),t.push({label:"朝向",value:e&&e.orientation?e.orientation:"-"}),t.push({label:"装修",value:e&&e.decoration_type?e.decoration_type:"-"});const o=Number(e&&e.build_year)||0;return t.push({label:"年代",value:o?`${o}年建`:"-"}),t.push({label:"物业类型",value:e&&e.property_type?e.property_type:"-"}),t},getCommissionText(e){const t=String(e&&e.commission_rate||"").trim(),r=String(e&&e.commission_reward||"").trim(),i=!!t&&"0"!==t&&"0.0"!==t&&"0.00"!==t,o=!!r&&"0"!==r&&"0.0"!==r&&"0.00"!==r;return i&&o?`佣金${t}% ，成交奖励￥${r}`:i?`佣金${t}%`:o?`成交奖励￥${r}`:"佣金待定"},mapPinText(){const e=String(this.property&&this.property.community_name||"").trim(),t=String(this.property&&this.property.address||"").trim();return e&&t?`${e} · ${t}`:e||t||"暂无位置信息"},async loadDetail(){if(this.loading||!this.propertyId)return!1;let r;this.loading=!0;try{r=await t.propertyApi.getDetail({id:this.propertyId})}catch(m){return this.loading=!1,e.index$1.getStorageSync("token")||e.index$1.reLaunch({url:"/pages/login/login"}),!1}if(this.loading=!1,!r||0!==r.code)return setTimeout((()=>{e.index$1.navigateBack()}),600),!1;const i=r.data||{},o=i.property||{};if(this.currentUserId||(this.currentUserId=Number(i.current_user||0)||0),!o||!o.id)return setTimeout((()=>{e.index$1.navigateBack()}),600),!1;this.property=o,this.isFollowed=!!i.is_followed,this.hasSmartLock=1===Number(o.has_smart_lock),this.ownerPhone=String(o.owner_phone||"").trim(),this.allowImageDownload=0!==Number(o.allow_image_download),this.allowVideoDownload=0!==Number(o.allow_video_download),this.videoUrl=String(o.video_url||"").trim(),this.videoPoster=String(o.cover_image||"").trim();const a=Array.isArray(i.images)?i.images:Array.isArray(o.images)?o.images:[];a.length>0&&(this.images=a),this.currentSwiper=0;const n=[];this.videoUrl&&n.push({type:"video",src:this.videoUrl}),(this.images||[]).forEach((e=>n.push({type:"image",src:e}))),this.bannerItems=n;const s=Number(o.latitude),p=Number(o.longitude);this.mapLat=isFinite(s)?s:0,this.mapLng=isFinite(p)?p:0,this.mapMarkers=this.mapLat&&this.mapLng?[{id:1,latitude:this.mapLat,longitude:this.mapLng,width:26,height:26}]:[],this.attributes=this.buildAttributes(o);const d=i.renovation||{},l=String(d.renovation_status||"").trim();let c="none";"in_progress"===l||"done"===l||"none"===l?c=l:"1"===l?c="in_progress":"2"===l&&(c="done"),this.renovation={status:c,subtitle:String(d.subtitle||"房源装修情况").trim()||"房源装修情况",progress:Number(d.progress_percentage||0)||0,stage:String(d.current_stage||"").trim()||"—",eta:String(d.estimated_finish_date||"").trim()||"—",finishAt:String(d.actual_finish_date||"").trim()||"—",materials:Array.isArray(d.materials)?d.materials:[],note:String(d.notes||"").trim()||"—",images:Array.isArray(d.images)?d.images:[]};const h=Array.isArray(i.recommends)?i.recommends:[];return this.recommends=h.map((e=>({id:e.id,name:e.title||e.name||"房源",rooms:this.getLayoutText(e),price:`${e.price||"-"}${e.price_unit||""}`,size:e.area||"-",image:e.image||""}))),!0},onPageScroll(e){const t=Number(e&&e.detail&&e.detail.scrollTop||0),r=Math.min(1,t/160);this.headerOpacity=Math.max(0,Math.min(1,Number(r.toFixed(3))))},goBack(){e.index$1.navigateBack()},goToRec(t){const r=Number(t&&(t.id||t.ID))||0;r&&r!==this.propertyId&&e.index$1.redirectTo({url:`/pages/property_detail/property_detail?id=${encodeURIComponent(r)}`})},swiperChange(e){this.currentSwiper=e.detail.current},getCurrentBannerItem(){return(Array.isArray(this.bannerItems)?this.bannerItems:[])[Number(this.currentSwiper)||0]||null},ensureAlbumPermission:()=>new Promise(((t,r)=>{e.index$1.getSetting({success:i=>{if(i&&i.authSetting&&i.authSetting["scope.writePhotosAlbum"])return t(!0);e.index$1.authorize({scope:"scope.writePhotosAlbum",success:()=>t(!0),fail:()=>{e.index$1.showModal({title:"需要相册权限",content:"保存到相册需要授权，请在设置中开启相册权限。",confirmText:"去设置",success:i=>{i.confirm?e.index$1.openSetting({success:()=>t(!0),fail:()=>r(!1)}):r(!1)}})}})},fail:()=>r(!1)})})),async downloadCurrent(){const t=this.getCurrentBannerItem();if(!t)return;if("video"===t.type&&!this.allowVideoDownload)return;if("image"===t.type&&!this.allowImageDownload)return;try{await this.ensureAlbumPermission()}catch(i){return}const r=String(t.src||"").trim();r&&(e.index$1.showLoading({title:"下载中..."}),e.index$1.downloadFile({url:r,success:r=>{const i=r&&r.tempFilePath;if(!i)return e.index$1.hideLoading(),void e.index$1.showToast({title:"下载失败",icon:"none"});"video"===t.type?e.index$1.saveVideoToPhotosAlbum({filePath:i,success:()=>e.index$1.showToast({title:"已保存视频",icon:"success"}),fail:()=>e.index$1.showToast({title:"保存失败",icon:"none"}),complete:()=>e.index$1.hideLoading()}):e.index$1.saveImageToPhotosAlbum({filePath:i,success:()=>e.index$1.showToast({title:"已保存图片",icon:"success"}),fail:()=>e.index$1.showToast({title:"保存失败",icon:"none"}),complete:()=>e.index$1.hideLoading()})},fail:()=>{e.index$1.hideLoading(),e.index$1.showToast({title:"下载失败",icon:"none"})}}))},handleShare(){const t=this.property&&this.property.title?this.property.title:"房源",r=this.propertyId;e.index$1.showActionSheet({itemList:["生成获客海报","复制房源链接","模拟分享（占位）"],success:i=>{if(0!==i.tapIndex)if(1!==i.tapIndex)2===i.tapIndex&&e.index$1.showToast({title:"分享功能待接入",icon:"none"});else{const i=r?`/pages/property_detail/property_detail?id=${encodeURIComponent(r)}`:"/pages/property_detail/property_detail";e.index$1.setClipboardData({data:`${t}\n${i}`,success:()=>e.index$1.showToast({title:"已复制链接",icon:"none"})})}else e.index$1.navigateTo({url:`/pages/marketing_posters/marketing_posters?title=${encodeURIComponent(t)}`})}})},openMap(){const t=Number(this.property&&this.property.latitude),r=Number(this.property&&this.property.longitude),i=String(this.property&&(this.property.community_name||this.property.title)||"房源").trim(),o=String(this.property&&this.property.address||"").trim();t&&r&&isFinite(t)&&isFinite(r)?e.index$1.openLocation({latitude:t,longitude:r,name:i,address:o||i,fail:()=>{e.index$1.showToast({title:"无法打开地图",icon:"none"})}}):e.index$1.showToast({title:"暂无定位信息",icon:"none"})},async toggleFollow(){if(!this.propertyId)return;let r;try{r=await t.propertyApi.toggleFollow({id:this.propertyId})}catch(o){return void(e.index$1.getStorageSync("token")||e.index$1.reLaunch({url:"/pages/login/login"}))}if(!r||0!==r.code)return;const i=r.data||{};this.isFollowed=!!i.is_followed,this.property&&(this.property.follow_count=i.follow_count),e.index$1.showToast({title:this.isFollowed?"已关注":"已取消关注",icon:"none"})},callOwner(){this.ownerPhone?e.index$1.makePhoneCall({phoneNumber:this.ownerPhone}):e.index$1.showToast({title:"暂无业主电话",icon:"none"})},openLock(){const t=String(this.property&&this.property.sale_status||"").trim();if("sold"!==t&&"off_market"!==t)this.hasSmartLock?e.index$1.navigateTo({url:`/pages/unlock_steps/unlock_steps?property_id=${encodeURIComponent(this.propertyId)}`}):e.index$1.showToast({title:"该房源未绑定智能锁，无法开锁",icon:"none"});else{const t=this.property&&this.property.sale_status_label?this.property.sale_status_label:"不可操作";e.index$1.showToast({title:`房源${t}，暂不可开锁`,icon:"none"})}},setRenovationStatus(e){}}};const a=e._export_sfc(o,[["render",function(t,r,o,a,n,s){return e.e({a:1-n.headerOpacity,b:n.headerOpacity,c:n.headerOpacity>.65?1:"",d:e.o(((...e)=>s.goBack&&s.goBack(...e))),e:n.headerTop+"px",f:n.headerPadLeftPx?n.headerPadLeftPx+"px":void 0,g:n.headerPadRightPx?n.headerPadRightPx+"px":void 0,h:e.f(n.bannerItems,((t,r,i)=>e.e({a:"video"===t.type},"video"===t.type?{b:t.src,c:n.videoPoster}:{d:t.src},{e:r}))),i:e.o(((...e)=>s.swiperChange&&s.swiperChange(...e))),j:s.showDownloadBtn},s.showDownloadBtn?{k:e.t(s.downloadLabel),l:e.o(((...e)=>s.downloadCurrent&&s.downloadCurrent(...e)))}:{},{m:e.t(n.bannerItems.length?n.currentSwiper+1:0),n:e.t(n.bannerItems.length),o:e.t(n.property&&n.property.title||"-"),p:e.o(((...e)=>s.handleShare&&s.handleShare(...e))),q:e.o(((...e)=>s.debugEditState&&s.debugEditState(...e))),r:s.canEditThisProperty},s.canEditThisProperty?{s:e.o(((...e)=>s.goEdit&&s.goEdit(...e)))}:{},{t:e.f((n.property&&n.property.tags||[]).slice(0,6),((t,r,i)=>({a:e.t(t),b:r,c:e.n(s.tagClass(t))}))),v:s.canEditThisProperty},s.canEditThisProperty?e.e({w:e.t(n.property&&n.property.sale_status_label||"状态"),x:e.n(n.property&&n.property.sale_status||""),y:1===Number(n.property&&n.property.hot_status)},(Number(n.property&&n.property.hot_status),{})):{},{z:e.t(n.property&&n.property.price||"-"),A:e.t(n.property&&n.property.price_unit||""),B:e.t(s.getLayoutText(n.property)),C:e.t(n.property&&n.property.area||"-"),D:e.t(s.getCommissionText(n.property)),E:e.t(n.property&&n.property.view_count||0),F:e.t(n.property&&n.property.follow_count||0),G:e.t(n.property&&n.property.showing_count||0),H:e.f(n.attributes,((t,r,i)=>({a:e.t(t.label),b:e.t(t.value),c:r}))),I:s.canEditThisProperty},s.canEditThisProperty?{J:e.t(n.property&&n.property.owner_name||"-"),K:e.t(n.property&&n.property.owner_phone||"-"),L:e.t(n.property&&n.property.receiver_name||"-"),M:e.t(n.property&&n.property.receiver_phone||"-"),N:e.t(n.property&&n.property.receiver_price?"¥"+n.property.receiver_price:"-")}:{},{O:e.f(n.renovationTabs,((t,r,i)=>({a:e.t(t.label),b:t.key,c:n.renovation.status===t.key?1:"",d:e.o((e=>s.setRenovationStatus(t.key)),t.key)}))),P:e.t("none"===n.renovation.status?"未装修":"in_progress"===n.renovation.status?"装修进行中":"装修完成"),Q:e.n(n.renovation.status),R:e.t(n.renovation.subtitle),S:"none"===n.renovation.status},"none"===n.renovation.status?{}:"in_progress"===n.renovation.status?{U:e.f(n.renovation.images,((e,t,r)=>({a:e,b:t}))),V:n.renovation.progress+"%",W:e.t(n.renovation.progress),X:e.t(n.renovation.stage),Y:e.t(n.renovation.eta),Z:e.f(n.renovation.materials,((t,r,i)=>({a:e.t(t),b:"m-"+r}))),aa:e.t(n.renovation.note)}:{ab:e.t(n.renovation.finishAt),ac:e.f(n.renovation.materials,((t,r,i)=>({a:e.t(t),b:"dm-"+r}))),ad:e.t(n.renovation.note)},{T:"in_progress"===n.renovation.status,ae:e.o(((...e)=>s.openMap&&s.openMap(...e))),af:s.hasLocation},s.hasLocation?{ag:n.mapLat,ah:n.mapLng,ai:n.mapMarkers,aj:e.o(((...e)=>s.openMap&&s.openMap(...e)))}:{ak:i._imports_0},{al:e.t(s.mapPinText()),am:s.hasLocation},s.hasLocation?{an:e.t(n.mapLng.toFixed(6)),ao:e.t(n.mapLat.toFixed(6))}:{},{ap:e.o(((...e)=>s.openMap&&s.openMap(...e))),aq:e.f(n.recommends,((t,r,i)=>({a:t.image,b:e.t(t.size),c:e.t(t.name),d:e.t(t.rooms),e:e.t(t.price),f:r,g:e.o((e=>s.goToRec(t)),r)}))),ar:e.o(((...e)=>s.onPageScroll&&s.onPageScroll(...e))),as:e.o(((...e)=>s.callOwner&&s.callOwner(...e))),at:n.isFollowed},(n.isFollowed,{}),{av:e.o(((...e)=>s.toggleFollow&&s.toggleFollow(...e))),aw:n.hasSmartLock},(n.hasSmartLock,{}),{ax:e.t(n.hasSmartLock?"智能锁":"未绑定智能锁"),ay:e.o(((...e)=>s.openLock&&s.openLock(...e)))})}]]);o.__runtimeHooks=1,wx.createPage(a);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/property_detail/property_detail.js.map
