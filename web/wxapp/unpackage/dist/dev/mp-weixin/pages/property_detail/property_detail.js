"use strict";const e=require("../../common/vendor.js"),t=require("../../api/property.js"),i=require("../../store/index.js"),r={data:()=>({propertyId:0,loading:!1,property:{},isPublicView:!1,publicFromAgentId:0,publicFromStyle:0,currentUserId:0,canManageProperties:!1,statusBarHeight:0,headerTop:0,headerPadLeftPx:0,headerPadRightPx:0,headerOpacity:0,currentSwiper:0,isFollowed:!1,hasSmartLock:!1,ownerPhone:"",images:[],bannerItems:[],videoUrl:"",videoPoster:"",allowImageDownload:!0,allowVideoDownload:!0,mapLat:0,mapLng:0,mapMarkers:[],attributes:[{label:"单价",value:"9,086元/m²"},{label:"楼层",value:"中层 / 共32层"},{label:"朝向",value:"南北通透"},{label:"装修",value:"精装修"},{label:"年代",value:"2019年建"},{label:"产权",value:"商品房"}],renovationTabs:[{key:"none",label:"未装修"},{key:"in_progress",label:"进行中"},{key:"done",label:"已完成"}],renovation:{status:"in_progress",subtitle:"高端精装，环保材料（示例）",progress:68,stage:"水电验收完成，正在进行泥木施工",eta:"预计 2026-02-20",finishAt:"2026-01-10",materials:["圣象地板","马可波罗瓷砖","多乐士乳胶漆"],note:"客厅墙面已完成找平与底漆，卫生间防水已做闭水试验；全屋线管/强弱电分离施工完成。",images:[]},recommends:[{name:"阳光花园三期 2室",rooms:"2室1厅",price:"72万",size:"89",image:""},{name:"金地名津 精装大三房",rooms:"3室2厅",price:"98万",size:"96",image:""},{name:"万科四季花城",rooms:"3室2厅",price:"105万",size:"110",image:""}]}),onLoad(t){const i=e.index$1.getSystemInfoSync();this.statusBarHeight=i.statusBarHeight;try{if(void 0!==e.wx$1&&e.wx$1.getMenuButtonBoundingClientRect){const t=e.wx$1.getMenuButtonBoundingClientRect(),r=Number(i.windowWidth||375),o=r/750,n=Math.round(32*o),a=Math.max(0,r-Number(t.left||0));this.headerPadLeftPx=n,this.headerPadRightPx=n+a;const s=80*o,p=Number(t.top||0)+Number(t.height||0)/2-s/2;this.headerTop=Math.max(Number(this.statusBarHeight||0),Math.round(p))}else this.headerTop=this.statusBarHeight+12}catch(n){this.headerTop=this.statusBarHeight+12}const r=String(t&&(t.public||t.is_public)||"").trim().toLowerCase();this.isPublicView="1"===r||"true"===r||"yes"===r,this.publicFromAgentId=Number(t&&(t.from_agent_id||t.agent_id||0))||0,this.publicFromStyle=Number(t&&t.from_style)||0;const o=Number(t&&(t.id||t.ID||t.property_id))||0;this.propertyId=o,this.propertyId?(this.isPublicView||this.ensureCanManageProperties(),this.loadDetail()):e.index$1.showToast({title:"房源ID缺失",icon:"none"})},computed:{canEditThisProperty(){if(this.isPublicView)return!1;if(!this.canManageProperties)return!1;if(!(Number(this.propertyId||0)||0))return!1;const e=Number(this.property&&this.property.agent_id)||0,t=Number(this.currentUserId||0)||0;return!(!t||!e)&&e===t},showDownloadBtn(){if(this.isPublicView)return!1;const e=this.getCurrentBannerItem();return!!e&&("video"===e.type?!!this.allowVideoDownload:"image"===e.type&&!!this.allowImageDownload)},downloadLabel(){const e=this.getCurrentBannerItem();return e?"video"===e.type?"下载视频":"下载图片":"下载"},hasLocation(){const e=Number(this.mapLat),t=Number(this.mapLng);return!!e&&!!t&&isFinite(e)&&isFinite(t)}},methods:{async ensureCanManageProperties(){if(this.isPublicView)return this.canManageProperties=!1,void(this.currentUserId=0);const t=i.$store("user");if(!e.index$1.getStorageSync("token")&&!t.isLogin)return this.canManageProperties=!1,void(this.currentUserId=0);try{const e=t.userInfo||{};e.id&&void 0!==e.can_manage_properties||await t.getInfo()}catch(o){}const r=t.userInfo||{};this.currentUserId=Number(r.id||0)||0,this.canManageProperties=1===Number(r.can_manage_properties);try{e.index$1.__f__("log","at pages/property_detail/property_detail.vue:742","[property_detail] perm",{id:this.currentUserId,can_manage_properties:r.can_manage_properties})}catch(o){}},goEdit(){this.propertyId&&e.index$1.navigateTo({url:`/pages/property_manage/property_edit?id=${this.propertyId}`})},debugEditState(){try{const t=Number(this.currentUserId||0)||0,i=!!this.canManageProperties,r=Number(this.property&&this.property.agent_id)||0,o=!!this.canEditThisProperty;e.index$1.showModal({title:"编辑按钮诊断",content:["can_manage_properties: "+(i?1:0),`currentUserId: ${t}`,`property.agent_id: ${r}`,"canEditThisProperty: "+(o?1:0),o?"✅ 满足条件应显示":"❌ 条件不满足所以不显示"].join("\n"),showCancel:!1})}catch(t){}},tagClass(e){const t=String(e||"").trim();return t&&(t.includes("急售")||t.includes("降价"))?"orange":""},getLayoutText(e){const t=Number(e&&e.rooms)||0,i=Number(e&&e.halls)||0,r=Number(e&&e.bathrooms)||0;if(!t&&!i&&!r)return"-";let o="";return t&&(o+=`${t}室`),i&&(o+=`${i}厅`),r&&(o+=`${r}卫`),o||"-"},getUnitPriceText(e){const t=Number(e&&e.price),i=Number(e&&e.area);if(!t||!i)return"-";let r=t;"万"===(e&&e.price_unit||"")&&(r=1e4*t);const o=r/i;return o&&isFinite(o)?`${Math.round(o).toLocaleString()}元/㎡`:"-"},buildAttributes(e){const t=[];t.push({label:"单价",value:this.getUnitPriceText(e)});const i=String(e&&e.floor_level||"").trim(),r=Number(e&&e.total_floors)||0;(i||r)&&t.push({label:"楼层",value:`${i||"-"}${r?` / 共${r}层`:""}`}),t.push({label:"朝向",value:e&&e.orientation?e.orientation:"-"}),t.push({label:"装修",value:e&&e.decoration_type?e.decoration_type:"-"});const o=Number(e&&e.build_year)||0;return t.push({label:"年代",value:o?`${o}年建`:"-"}),t.push({label:"物业类型",value:e&&e.property_type?e.property_type:"-"}),t},getCommissionText(e){const t=String(e&&e.commission_rate||"").trim(),i=String(e&&e.commission_reward||"").trim(),r=!!t&&"0"!==t&&"0.0"!==t&&"0.00"!==t,o=!!i&&"0"!==i&&"0.0"!==i&&"0.00"!==i;return r&&o?`佣金${t}% ，成交奖励￥${i}`:r?`佣金${t}%`:o?`成交奖励￥${i}`:"佣金待定"},mapPinText(){const e=String(this.property&&this.property.community_name||"").trim(),t=String(this.property&&this.property.address||"").trim();return e&&t?`${e} · ${t}`:e||t||"暂无位置信息"},normalizeImage(e){const t=String(e||"").trim();return t?0===t.indexOf("/static/images/")?"":t:""},async loadDetail(){if(this.loading||!this.propertyId)return!1;let i;this.loading=!0;try{i=await t.propertyApi.getDetail({id:this.propertyId,public:this.isPublicView?1:0})}catch(h){return this.loading=!1,this.isPublicView||e.index$1.getStorageSync("token")||e.index$1.reLaunch({url:"/pages/login/login"}),!1}if(this.loading=!1,!i||0!==i.code){const t=String(i&&(i.message||i.msg)||"").trim();return!this.isPublicView&&/登录|token|认证/i.test(t)?(e.index$1.reLaunch({url:"/pages/login/login"}),!1):(setTimeout((()=>{this.goBack()}),600),!1)}const r=i.data||{};void 0!==r.public_view&&(this.isPublicView=!!r.public_view);const o=r.property||{};if(this.currentUserId||(this.currentUserId=Number(r.current_user||0)||0),!o||!o.id)return setTimeout((()=>{e.index$1.navigateBack()}),600),!1;this.property=o,this.isFollowed=!!r.is_followed,this.hasSmartLock=1===Number(o.has_smart_lock),this.ownerPhone=String(o.owner_phone||"").trim(),this.isPublicView&&(this.ownerPhone=""),this.allowImageDownload=0!==Number(o.allow_image_download),this.allowVideoDownload=0!==Number(o.allow_video_download),this.videoUrl=String(o.video_url||"").trim(),this.videoPoster=this.normalizeImage(o.cover_image);const n=(Array.isArray(r.images)?r.images:Array.isArray(o.images)?o.images:[]).map((e=>this.normalizeImage(e))).filter(Boolean);this.images=n,this.currentSwiper=0;const a=[];this.videoUrl&&a.push({type:"video",src:this.videoUrl}),(this.images||[]).forEach((e=>a.push({type:"image",src:e}))),this.bannerItems=a;const s=Number(o.latitude),p=Number(o.longitude);this.mapLat=isFinite(s)?s:0,this.mapLng=isFinite(p)?p:0,this.mapMarkers=this.mapLat&&this.mapLng?[{id:1,latitude:this.mapLat,longitude:this.mapLng,width:26,height:26}]:[],this.attributes=this.buildAttributes(o);const l=r.renovation||{},d=String(l.renovation_status||"").trim();let c="none";"in_progress"===d||"done"===d||"none"===d?c=d:"1"===d?c="in_progress":"2"===d&&(c="done"),this.renovation={status:c,subtitle:String(l.subtitle||"房源装修情况").trim()||"房源装修情况",progress:Number(l.progress_percentage||0)||0,stage:String(l.current_stage||"").trim()||"—",eta:String(l.estimated_finish_date||"").trim()||"—",finishAt:String(l.actual_finish_date||"").trim()||"—",materials:Array.isArray(l.materials)?l.materials:[],note:String(l.notes||"").trim()||"—",images:Array.isArray(l.images)?l.images.map((e=>this.normalizeImage(e))).filter(Boolean):[]};const u=Array.isArray(r.recommends)?r.recommends:[];return this.recommends=u.map((e=>({id:e.id,name:e.title||e.name||"房源",rooms:this.getLayoutText(e),price:`${e.price||"-"}${e.price_unit||""}`,size:e.area||"-",image:this.normalizeImage(e.image||e.cover_image||"")}))),!0},onPageScroll(e){const t=Number(e&&e.detail&&e.detail.scrollTop||0),i=Math.min(1,t/160);this.headerOpacity=Math.max(0,Math.min(1,Number(i.toFixed(3))))},goBack(){if(!this.isPublicView)return void e.index$1.navigateBack();const t=getCurrentPages?getCurrentPages():[];if(t&&t.length>1)return void e.index$1.navigateBack();const i=Number(this.publicFromAgentId||0),r=Number(this.publicFromStyle||0);i>0?e.index$1.reLaunch({url:`/pages/agent_public_card/agent_public_card?agent_id=${encodeURIComponent(i)}&style=${encodeURIComponent(r)}`}):e.index$1.reLaunch({url:"/pages/login/login"})},goToRec(t){const i=Number(t&&(t.id||t.ID))||0;if(!i)return;if(i===this.propertyId)return;const r=this.isPublicView?`&public=1&from_agent_id=${encodeURIComponent(this.publicFromAgentId)}&from_style=${encodeURIComponent(this.publicFromStyle)}`:"";e.index$1.redirectTo({url:`/pages/property_detail/property_detail?id=${encodeURIComponent(i)}${r}`})},swiperChange(e){this.currentSwiper=e.detail.current},getCurrentBannerItem(){return(Array.isArray(this.bannerItems)?this.bannerItems:[])[Number(this.currentSwiper)||0]||null},ensureAlbumPermission:()=>new Promise(((t,i)=>{e.index$1.getSetting({success:r=>{if(r&&r.authSetting&&r.authSetting["scope.writePhotosAlbum"])return t(!0);e.index$1.authorize({scope:"scope.writePhotosAlbum",success:()=>t(!0),fail:()=>{e.index$1.showModal({title:"需要相册权限",content:"保存到相册需要授权，请在设置中开启相册权限。",confirmText:"去设置",success:r=>{r.confirm?e.index$1.openSetting({success:()=>t(!0),fail:()=>i(!1)}):i(!1)}})}})},fail:()=>i(!1)})})),async downloadCurrent(){if(this.isPublicView)return;const t=this.getCurrentBannerItem();if(!t)return;if("video"===t.type&&!this.allowVideoDownload)return;if("image"===t.type&&!this.allowImageDownload)return;try{await this.ensureAlbumPermission()}catch(r){return}const i=String(t.src||"").trim();i&&(e.index$1.showLoading({title:"下载中..."}),e.index$1.downloadFile({url:i,success:i=>{const r=i&&i.tempFilePath;if(!r)return e.index$1.hideLoading(),void e.index$1.showToast({title:"下载失败",icon:"none"});"video"===t.type?e.index$1.saveVideoToPhotosAlbum({filePath:r,success:()=>e.index$1.showToast({title:"已保存视频",icon:"success"}),fail:()=>e.index$1.showToast({title:"保存失败",icon:"none"}),complete:()=>e.index$1.hideLoading()}):e.index$1.saveImageToPhotosAlbum({filePath:r,success:()=>e.index$1.showToast({title:"已保存图片",icon:"success"}),fail:()=>e.index$1.showToast({title:"保存失败",icon:"none"}),complete:()=>e.index$1.hideLoading()})},fail:()=>{e.index$1.hideLoading(),e.index$1.showToast({title:"下载失败",icon:"none"})}}))},handleShare(){if(this.isPublicView)return;const t=this.property&&this.property.title?this.property.title:"房源",i=this.propertyId;e.index$1.showActionSheet({itemList:["生成获客海报","复制房源链接","模拟分享（占位）"],success:r=>{if(0!==r.tapIndex)if(1!==r.tapIndex)2===r.tapIndex&&e.index$1.showToast({title:"分享功能待接入",icon:"none"});else{const r=i?`/pages/property_detail/property_detail?id=${encodeURIComponent(i)}`:"/pages/property_detail/property_detail";e.index$1.setClipboardData({data:`${t}\n${r}`,success:()=>e.index$1.showToast({title:"已复制链接",icon:"none"})})}else e.index$1.navigateTo({url:`/pages/marketing_posters/marketing_posters?title=${encodeURIComponent(t)}`})}})},openMap(){if(this.isPublicView)return void e.index$1.showToast({title:"公开页不支持跳转地图",icon:"none"});const t=Number(this.property&&this.property.latitude),i=Number(this.property&&this.property.longitude),r=String(this.property&&(this.property.community_name||this.property.title)||"房源").trim(),o=String(this.property&&this.property.address||"").trim();t&&i&&isFinite(t)&&isFinite(i)?e.index$1.openLocation({latitude:t,longitude:i,name:r,address:o||r,fail:()=>{e.index$1.showToast({title:"无法打开地图",icon:"none"})}}):e.index$1.showToast({title:"暂无定位信息",icon:"none"})},async toggleFollow(){if(this.isPublicView)return;if(!this.propertyId)return;let i;try{i=await t.propertyApi.toggleFollow({id:this.propertyId})}catch(o){return void(e.index$1.getStorageSync("token")||e.index$1.reLaunch({url:"/pages/login/login"}))}if(!i||0!==i.code)return;const r=i.data||{};this.isFollowed=!!r.is_followed,this.property&&(this.property.follow_count=r.follow_count),e.index$1.showToast({title:this.isFollowed?"已关注":"已取消关注",icon:"none"})},callOwner(){this.isPublicView||(this.ownerPhone?e.index$1.makePhoneCall({phoneNumber:this.ownerPhone}):e.index$1.showToast({title:"暂无业主电话",icon:"none"}))},openLock(){if(this.isPublicView)return;const t=String(this.property&&this.property.sale_status||"").trim();if("sold"!==t&&"off_market"!==t)this.hasSmartLock?e.index$1.navigateTo({url:`/pages/unlock_steps/unlock_steps?property_id=${encodeURIComponent(this.propertyId)}`}):e.index$1.showToast({title:"该房源未绑定智能锁，无法开锁",icon:"none"});else{const t=this.property&&this.property.sale_status_label?this.property.sale_status_label:"不可操作";e.index$1.showToast({title:`房源${t}，暂不可开锁`,icon:"none"})}},setRenovationStatus(e){}}};const o=e._export_sfc(r,[["render",function(t,i,r,o,n,a){return e.e({a:1-n.headerOpacity,b:n.headerOpacity,c:n.headerOpacity>.65?1:"",d:e.o(((...e)=>a.goBack&&a.goBack(...e))),e:n.headerTop+"px",f:n.headerPadLeftPx?n.headerPadLeftPx+"px":void 0,g:n.headerPadRightPx?n.headerPadRightPx+"px":void 0,h:e.f(n.bannerItems,((t,i,r)=>e.e({a:"video"===t.type},"video"===t.type?{b:t.src,c:n.videoPoster}:{d:t.src},{e:i}))),i:e.o(((...e)=>a.swiperChange&&a.swiperChange(...e))),j:a.showDownloadBtn},a.showDownloadBtn?{k:e.t(a.downloadLabel),l:e.o(((...e)=>a.downloadCurrent&&a.downloadCurrent(...e)))}:{},{m:e.t(n.bannerItems.length?n.currentSwiper+1:0),n:e.t(n.bannerItems.length),o:e.t(n.property&&n.property.title||"-"),p:!n.isPublicView},n.isPublicView?{}:{q:e.o(((...e)=>a.handleShare&&a.handleShare(...e))),r:e.o(((...e)=>a.debugEditState&&a.debugEditState(...e)))},{s:a.canEditThisProperty},a.canEditThisProperty?{t:e.o(((...e)=>a.goEdit&&a.goEdit(...e)))}:{},{v:e.f((n.property&&n.property.tags||[]).slice(0,6),((t,i,r)=>({a:e.t(t),b:i,c:e.n(a.tagClass(t))}))),w:a.canEditThisProperty},a.canEditThisProperty?e.e({x:e.t(n.property&&n.property.sale_status_label||"状态"),y:e.n(n.property&&n.property.sale_status||""),z:1===Number(n.property&&n.property.hot_status)},(Number(n.property&&n.property.hot_status),{})):{},{A:e.t(n.property&&n.property.price||"-"),B:e.t(n.property&&n.property.price_unit||""),C:e.t(a.getLayoutText(n.property)),D:e.t(n.property&&n.property.area||"-"),E:!n.isPublicView},n.isPublicView?{}:{F:e.t(a.getCommissionText(n.property))},{G:e.t(n.property&&n.property.view_count||0),H:e.t(n.property&&n.property.follow_count||0),I:e.t(n.property&&n.property.showing_count||0),J:e.f(n.attributes,((t,i,r)=>({a:e.t(t.label),b:e.t(t.value),c:i}))),K:a.canEditThisProperty},a.canEditThisProperty?{L:e.t(n.property&&n.property.owner_name||"-"),M:e.t(n.property&&n.property.owner_phone||"-"),N:e.t(n.property&&n.property.receiver_name||"-"),O:e.t(n.property&&n.property.receiver_phone||"-"),P:e.t(n.property&&n.property.receiver_price?"¥"+n.property.receiver_price:"-")}:{},{Q:e.f(n.renovationTabs,((t,i,r)=>({a:e.t(t.label),b:t.key,c:n.renovation.status===t.key?1:"",d:e.o((e=>a.setRenovationStatus(t.key)),t.key)}))),R:e.t("none"===n.renovation.status?"未装修":"in_progress"===n.renovation.status?"装修进行中":"装修完成"),S:e.n(n.renovation.status),T:e.t(n.renovation.subtitle),U:"none"===n.renovation.status},"none"===n.renovation.status?{}:"in_progress"===n.renovation.status?{W:e.f(n.renovation.images,((e,t,i)=>({a:e,b:t}))),X:n.renovation.progress+"%",Y:e.t(n.renovation.progress),Z:e.t(n.renovation.stage),aa:e.t(n.renovation.eta),ab:e.f(n.renovation.materials,((t,i,r)=>({a:e.t(t),b:"m-"+i}))),ac:e.t(n.renovation.note)}:{ad:e.t(n.renovation.finishAt),ae:e.f(n.renovation.materials,((t,i,r)=>({a:e.t(t),b:"dm-"+i}))),af:e.t(n.renovation.note)},{V:"in_progress"===n.renovation.status,ag:e.o(((...e)=>a.openMap&&a.openMap(...e))),ah:a.hasLocation},a.hasLocation?{ai:n.mapLat,aj:n.mapLng,ak:n.mapMarkers,al:e.o(((...e)=>a.openMap&&a.openMap(...e)))}:{},{am:e.t(a.mapPinText()),an:a.hasLocation},a.hasLocation?{ao:e.t(n.mapLng.toFixed(6)),ap:e.t(n.mapLat.toFixed(6))}:{},{aq:e.o(((...e)=>a.openMap&&a.openMap(...e))),ar:e.f(n.recommends,((t,i,r)=>e.e({a:a.normalizeImage(t.image)},a.normalizeImage(t.image)?{b:a.normalizeImage(t.image)}:{},{c:e.t(t.size),d:e.t(t.name),e:e.t(t.rooms),f:e.t(t.price),g:i,h:e.o((e=>a.goToRec(t)),i)}))),as:!n.isPublicView},(n.isPublicView,{}),{at:e.o(((...e)=>a.onPageScroll&&a.onPageScroll(...e))),av:!n.isPublicView},n.isPublicView?{}:e.e({aw:e.o(((...e)=>a.callOwner&&a.callOwner(...e))),ax:n.isFollowed},(n.isFollowed,{}),{ay:e.o(((...e)=>a.toggleFollow&&a.toggleFollow(...e))),az:n.hasSmartLock},(n.hasSmartLock,{}),{aA:e.t(n.hasSmartLock?"智能锁":"未绑定智能锁"),aB:e.o(((...e)=>a.openLock&&a.openLock(...e)))}))}]]);r.__runtimeHooks=1,wx.createPage(o);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/property_detail/property_detail.js.map
